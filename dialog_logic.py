"""
–õ–æ–≥–∏–∫–∞ –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±–æ—Ç–∞ GLADIS
"""

import re
from typing import Dict, Any

def analyze_client_needs_simple(message: str, session: Dict[str, Any]) -> str:
    """
    –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ AI.
    """
    message_lower = message.lower()
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    greetings = [
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ø—Ä–∏–≤–µ—Ç", "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫",
        "–∑–¥—Ä–∞—Å—å—Ç–µ", "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é"
    ]
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if any(greeting in message_lower for greeting in greetings):
        return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞.\n\n–ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
    
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
    wants_to_register = any(word in message_lower for word in [
        "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º", "—Ö–æ—á—É –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è", "—Ö–æ—Ç–µ–ª –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
    ])
    
    if wants_to_register:
        return "–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏. –£–∫–∞–∂–∏—Ç–µ –∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
    
    # –û–±—â–∏–π –æ—Ç–≤–µ—Ç
    return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞.\n\n–ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å."

def should_move_to_contacts(message: str, session: Dict[str, Any]) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø–æ—Ä–∞ –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–±–æ—Ä—É –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
    """
    message_lower = message.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
    ready_keywords = [
        "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", 
        "–≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º", "—Ö–æ—á—É –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É",
        "–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∑–∞–ø–∏—Å—å", "—Ö–æ—á—É —Å–¥–µ–ª–∞—Ç—å", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è",
        "–¥–∞–≤–∞–π—Ç–µ", "—Å–æ–≥–ª–∞—Å–µ–Ω", "–æ–∫", "—Ö–æ—Ä–æ—à–æ", "–∏–¥–µ–º—Ç–µ", "—Ö–æ—Ç–µ–ª –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
    ]
    
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –∑–∞–ø–∏—Å–∏
    if any(keyword in message_lower for keyword in ready_keywords):
        return True
    
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    contact_patterns = [
        r'\d{10,11}',
        r'[\+7]?[-\s]?\(?\d{3}\)?[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2,3}',
        r'–º–µ–Ω—è\s+–∑–æ–≤—É—Ç',
        r'–∏–º—è\s+',
        r'—Ç–µ–ª–µ—Ñ–æ–Ω'
    ]
    
    for pattern in contact_patterns:
        if re.search(pattern, message_lower):
            return True
    
    # –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ
    if session.get('message_count', 0) >= 5:
        return True
    
    return False

def handle_contact_collection(message: str, session: Dict[str, Any]) -> str:
    """
    –≠—Ç–∞–ø 4: –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
    """
    print(f"üîç –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è: '{message}'")
    
    # –ò—â–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
    phone_pattern = r'[\+7]?[-\s]?\(?\d{3}\)?[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2,3}'
    phone_matches = re.findall(phone_pattern, message)
    
    # –¢–∞–∫–∂–µ –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ 11 —Ü–∏—Ñ—Ä –ø–æ–¥—Ä—è–¥
    if not phone_matches:
        phone_pattern2 = r'\b\d{10,11}\b'
        phone_matches = re.findall(phone_pattern2, message)
    
    # –£–¥–∞–ª—è–µ–º –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if phone_matches:
        clean_phone = re.sub(r'\D', '', phone_matches[0])
        if 10 <= len(clean_phone) <= 11:
            session['phone'] = clean_phone
            print(f"üìû –ù–∞–π–¥–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω: {session['phone']}")
    
    # –ò—â–µ–º –∏–º—è
    words = re.findall(r'[–ê-–Ø–Å–∞-—è—ëA-Za-z]+', message)
    
    # –ò—â–µ–º —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã (–∏–º–µ–Ω–∞)
    russian_words = [word for word in words if re.match(r'^[–ê-–Ø–Å][–∞-—è—ë]*$', word)]
    
    if russian_words and not session['name']:
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã –∫–∞–∫ –∏–º—è
        session['name'] = russian_words[0]
        print(f"üë§ –ù–∞–π–¥–µ–Ω–æ –∏–º—è: {session['name']}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å
    has_name = bool(session['name'])
    has_phone = bool(session['phone'])
    
    if has_name and has_phone:
        return "–°–ø–∞—Å–∏–±–æ! –°–µ–π—á–∞—Å –ø–µ—Ä–µ–¥–∞–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    elif has_name and not has_phone:
        return f"–°–ø–∞—Å–∏–±–æ, {session['name']}! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏."
    elif has_phone and not has_name:
        return f"–°–ø–∞—Å–∏–±–æ! –í–∏–∂—É –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω {session['phone']}. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"
    else:
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –ø—Ä–æ—Å–∏–º –æ–±–∞
        return "–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏. –£–∫–∞–∂–∏—Ç–µ –∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
