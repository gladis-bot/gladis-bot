"""
–õ–æ–≥–∏–∫–∞ –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±–æ—Ç–∞ GLADIS
"""

import re
import time
from typing import Dict, Any

def analyze_client_needs(message: str, session: Dict[str, Any]) -> str:
    """
    –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞.
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.
    """
    message_lower = message.lower()
    
    # –°–ª–æ–≤–∞—Ä—å –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π
    procedures_info = {
        "—ç–ø–∏–ª—è—Ü–∏—è": {
            "name": "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è",
            "description": "–£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ª–æ—Å –ª–∞–∑–µ—Ä–æ–º - –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∫—É—Ä—Å–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä",
            "types": [
                "–ì–∏–±—Ä–∏–¥–Ω—ã–π –ª–∞–∑–µ—Ä Innovation - –±–æ–ª–µ–µ –º—è–≥–∫–∏–π, –±–æ–ª—å—à–µ —Å–µ–∞–Ω—Å–æ–≤ (8-12)",
                "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π –ª–∞–∑–µ—Ä Quanta System - –±–æ–ª–µ–µ –º–æ—â–Ω—ã–π, –º–µ–Ω—å—à–µ —Å–µ–∞–Ω—Å–æ–≤ (5-7)"
            ],
            "questions": [
                "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ø–æ–¥–º—ã—à–∫–∏, –±–∏–∫–∏–Ω–∏, –Ω–æ–≥–∏, –ª–∏—Ü–æ –∏ —Ç.–¥.)",
                "–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∏–ø –∫–æ–∂–∏ –∏ —Ü–≤–µ—Ç –≤–æ–ª–æ—Å? (—Å–≤–µ—Ç–ª—ã–µ/—Ç–µ–º–Ω—ã–µ, —Ç–æ–Ω–∫–∏–µ/–≥—Ä—É–±—ã–µ)"
            ]
        },
        "–ø–∏–ª–∏–Ω–≥": {
            "name": "–ü–∏–ª–∏–Ω–≥",
            "description": "–•–∏–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–∂–∏",
            "types": [
                "Peach peel - 4500 —Ä—É–± (–æ–º–æ–ª–∞–∂–∏–≤–∞—é—â–∏–π)",
                "Peel RDX, 07, 22 - 2000 —Ä—É–±",
                "–ö–∞—Ä–±–æ–Ω–æ–≤—ã–π - 2000 —Ä—É–± (–¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –∫–æ–∂–∏)",
                "–ü–∏—Ä–æ–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π - 2500 —Ä—É–±"
            ],
            "questions": [
                "–ö–∞–∫–æ–π —Ç–∏–ø –∫–æ–∂–∏ —É –≤–∞—Å? (–∂–∏—Ä–Ω–∞—è, —Å—É—Ö–∞—è, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –ø—Ä–æ–±–ª–µ–º–Ω–∞—è)",
                "–ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å? (–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ, –ª–µ—á–µ–Ω–∏–µ –∞–∫–Ω–µ, –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ)"
            ]
        },
        "—á–∏—Å—Ç–∫–∞": {
            "name": "–ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞",
            "description": "–ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∏–ª–∏ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è —á–∏—Å—Ç–∫–∞",
            "types": [
                "–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è - 3900 —Ä—É–± (–±–µ—Ä–µ–∂–Ω–∞—è —á–∏—Å—Ç–∫–∞)",
                "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è - 3900 —Ä—É–± (–≥–ª—É–±–æ–∫–∞—è —á–∏—Å—Ç–∫–∞)",
                "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - 3900 —Ä—É–±",
                "Hydrafacial –≥–∏–¥—Ä–æ–ø–∏–ª–∏–Ω–≥ - 4500 —Ä—É–± (–≤–∞–∫—É—É–º–Ω–∞—è —á–∏—Å—Ç–∫–∞)"
            ],
            "questions": [
                "–ö–∞–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–∂–∏? (–∞–∫–Ω–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã, —á–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏)",
                "–ë—ã–ª–∏ –ª–∏ —É –≤–∞—Å —á–∏—Å—Ç–∫–∏ —Ä–∞–Ω—å—à–µ?"
            ]
        },
        "–±–æ—Ç–æ–∫—Å": {
            "name": "–ë–æ—Ç—É–ª–æ—Ç–æ–∫—Å–∏–Ω",
            "description": "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –º–∏–º–∏—á–µ—Å–∫–∏—Ö –º–æ—Ä—â–∏–Ω",
            "types": [
                "–†–µ–ª–∞—Ç–æ–∫—Å - 250 —Ä—É–±/–µ–¥.",
                "–ë–æ—Ç—É–ª–∞–∫—Å - 250 —Ä—É–±/–µ–¥.",
                "–ì–∏–ø–µ—Ä–≥–∏–¥—Ä–æ–∑ (2 —à—Ç) - 20000 —Ä—É–±"
            ],
            "questions": [
                "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ª–æ–±, –º–µ–∂–±—Ä–æ–≤—å–µ, –≥—É—Å–∏–Ω—ã–µ –ª–∞–ø–∫–∏)",
                "–î–µ–ª–∞–ª–∏ –ª–∏ –∏–Ω—ä–µ–∫—Ü–∏–∏ –±–æ—Ç—É–ª–æ—Ç–æ–∫—Å–∏–Ω–∞ —Ä–∞–Ω—å—à–µ?"
            ]
        },
        "–ª–∏—Ñ—Ç–∏–Ω–≥": {
            "name": "–õ–∏—Ñ—Ç–∏–Ω–≥",
            "description": "–ü–æ–¥—Ç—è–∂–∫–∞ –∫–æ–∂–∏",
            "types": [
                "–ú–∏–∫—Ä–æ–∏–≥–æ–ª—å—á–∞—Ç—ã–π RF-–ª–∏—Ñ—Ç–∏–Ω–≥ - –æ—Ç 16500 —Ä—É–±",
                "SMAS-–ª–∏—Ñ—Ç–∏–Ω–≥ - –æ—Ç 14000 —Ä—É–±"
            ],
            "questions": [
                "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ª–∏—Ü–æ, —à–µ—è, –¥–µ–∫–æ–ª—å—Ç–µ)",
                "–ö–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∫–æ–∂–∏?"
            ]
        }
    }
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ –∫–∞–∫–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç
    found_procedure = None
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —ç–ø–∏–ª—è—Ü–∏–∏
    if any(word in message_lower for word in ["—ç–ø–∏–ª—è—Ü–∏—è", "–ª–∞–∑–µ—Ä", "—É–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ª–æ—Å", "–ø–æ–¥–º—ã—à–µ–∫", "–±–∏–∫–∏–Ω–∏", "–≥–æ–ª–µ–Ω–∏", "–Ω–æ–≥–∏"]):
        found_procedure = "—ç–ø–∏–ª—è—Ü–∏—è"
        session['procedure_category'] = "–õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è"
    else:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
        for proc_key, proc_info in procedures_info.items():
            if proc_key in message_lower:
                found_procedure = proc_key
                session['procedure_category'] = proc_info['name']
                break
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    if found_procedure:
        proc_info = procedures_info[found_procedure]
        
        response = f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞.\n\n"
        
        # –î–ª—è —ç–ø–∏–ª—è—Ü–∏–∏ - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        if found_procedure == "—ç–ø–∏–ª—è—Ü–∏—è":
            response += f"–û—Ç–ª–∏—á–Ω–æ! –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è - —ç—Ç–æ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ª–æ—Å.\n\n"
            response += f"–£ –Ω–∞—Å –¥–≤–∞ —Ç–∏–ø–∞ –ª–∞–∑–µ—Ä–æ–≤:\n"
            response += f"1. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ª–∞–∑–µ—Ä Innovation - –º—è–≥–∫–∏–π, –∫—É—Ä—Å 8-12 –ø—Ä–æ—Ü–µ–¥—É—Ä\n"
            response += f"2. –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π –ª–∞–∑–µ—Ä Quanta System - –º–æ—â–Ω—ã–π, –∫—É—Ä—Å 5-7 –ø—Ä–æ—Ü–µ–¥—É—Ä\n\n"
            response += f"–ö–∞–∫–∏–µ –∑–æ–Ω—ã –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ø–æ–¥–º—ã—à–∫–∏, –±–∏–∫–∏–Ω–∏, –Ω–æ–≥–∏, –ª–∏—Ü–æ –∏ —Ç.–¥.)"
            session['stage'] = 'details_clarification'
            
        else:
            response += f"–û—Ç–ª–∏—á–Ω–æ! {proc_info['description']}.\n\n"
            response += f"–£ –Ω–∞—Å –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n"
            
            for i, proc_type in enumerate(proc_info['types'], 1):
                response += f"{i}. {proc_type}\n"
            
            response += "\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
            if proc_info['questions']:
                response += "–ß—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤:\n"
                for i, question in enumerate(proc_info['questions'], 1):
                    response += f"{i}. {question}\n"
                session['stage'] = 'details_clarification'
            else:
                response += "–ö–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n"
                session['stage'] = 'consultation'
    
    else:
        # –ï—Å–ª–∏ –Ω–µ –ø–æ–Ω—è–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É
        response = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞.\n\n"
        response += "–ü–æ–Ω—è–ª–∞, –≤—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç–µ –ø—Ä–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n\n"
        response += "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        response += "- –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ª–æ—Å)\n"
        response += "- –ß–∏—Å—Ç–∫–∞ –∏–ª–∏ –ø–∏–ª–∏–Ω–≥ –¥–ª—è –ª–∏—Ü–∞\n"
        response += "- –ë–æ—Ç—É–ª–æ—Ç–æ–∫—Å–∏–Ω –æ—Ç –º–æ—Ä—â–∏–Ω\n"
        response += "- –õ–∏—Ñ—Ç–∏–Ω–≥ –∏–ª–∏ –ø–æ–¥—Ç—è–∂–∫–∞ –∫–æ–∂–∏\n\n"
        response += "–ò–ª–∏ –∑–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö!"
    
    # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤ –∫–æ–Ω—Ü–µ –¥–∏–∞–ª–æ–≥–∞, –∞ –Ω–µ —Å—Ä–∞–∑—É
    if session['stage'] == 'completed' or session.get('telegram_sent'):
        response += "\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-928-458-32-88"
        response += "\nüìç –ê–¥—Ä–µ—Å–∞:"
        response += "\n   üìç –°–æ—á–∏: —É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22"
        response += "\n   üìç –ê–¥–ª–µ—Ä: —É–ª. –ö–∏—Ä–æ–≤–∞, –¥. 26–∞"
        response += "\n‚è∞ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ 10:00-20:00"
    
    return response

def clarify_procedure_details(message: str, session: Dict[str, Any]) -> str:
    """
    –≠—Ç–∞–ø 3: –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
    """
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞
    if 'questions_answered' not in session:
        session['questions_answered'] = []
    
    session['questions_answered'].append(message)
    
    # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–¥–∞–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    procedure = session.get('procedure_category', '').lower()
    
    if '—ç–ø–∏–ª—è—Ü–∏—è' in procedure:
        return handle_epilation_details(message, session)
    elif '—á–∏—Å—Ç–∫–∞' in procedure or '–ø–∏–ª–∏–Ω–≥' in procedure:
        return handle_skin_procedure_details(message, session)
    elif '–±–æ—Ç–æ–∫—Å' in procedure:
        return handle_botox_details(message, session)
    elif '–ª–∏—Ñ—Ç–∏–Ω–≥' in procedure:
        return handle_lifting_details(message, session)
    else:
        # –û–±—â–∏–π —Å–ª—É—á–∞–π
        if len(session['questions_answered']) >= 2:
            session['stage'] = 'contact_collection'
            return "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω. –£–∫–∞–∂–∏—Ç–µ –∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
        else:
            next_question = get_next_question(session)
            return next_question

def get_next_question(session: Dict[str, Any]) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã."""
    procedure = session.get('procedure_category', '').lower()
    questions_answered = len(session.get('questions_answered', []))
    
    if '—ç–ø–∏–ª—è—Ü–∏—è' in procedure:
        if questions_answered == 0:
            return "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ø–æ–¥–º—ã—à–∫–∏, –±–∏–∫–∏–Ω–∏, –Ω–æ–≥–∏, –ª–∏—Ü–æ –∏ —Ç.–¥.)"
        elif questions_answered == 1:
            return "–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∏–ø –∫–æ–∂–∏ –∏ —Ü–≤–µ—Ç –≤–æ–ª–æ—Å? (—Å–≤–µ—Ç–ª—ã–µ/—Ç–µ–º–Ω—ã–µ, —Ç–æ–Ω–∫–∏–µ/–≥—Ä—É–±—ã–µ)"
        elif questions_answered == 2:
            return "–î–µ–ª–∞–ª–∏ –ª–∏ –ª–∞–∑–µ—Ä–Ω—É—é —ç–ø–∏–ª—è—Ü–∏—é —Ä–∞–Ω—å—à–µ? –ï—Å–ª–∏ –¥–∞, —Ç–æ –Ω–∞ –∫–∞–∫–æ–º –∞–ø–ø–∞—Ä–∞—Ç–µ?"
    
    elif '—á–∏—Å—Ç–∫–∞' in procedure or '–ø–∏–ª–∏–Ω–≥' in procedure:
        if questions_answered == 0:
            return "–ö–∞–∫–æ–π —Ç–∏–ø –∫–æ–∂–∏ —É –≤–∞—Å? (–∂–∏—Ä–Ω–∞—è, —Å—É—Ö–∞—è, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –ø—Ä–æ–±–ª–µ–º–Ω–∞—è)"
        elif questions_answered == 1:
            return "–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∫–æ–∂–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å? (–∞–∫–Ω–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã, –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è, –º–æ—Ä—â–∏–Ω—ã)"
    
    elif '–±–æ—Ç–æ–∫—Å' in procedure:
        if questions_answered == 0:
            return "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ª–æ–±, –º–µ–∂–±—Ä–æ–≤—å–µ, –≥—É—Å–∏–Ω—ã–µ –ª–∞–ø–∫–∏)"
        elif questions_answered == 1:
            return "–î–µ–ª–∞–ª–∏ –ª–∏ –∏–Ω—ä–µ–∫—Ü–∏–∏ –±–æ—Ç—É–ª–æ—Ç–æ–∫—Å–∏–Ω–∞ —Ä–∞–Ω—å—à–µ? –ï—Å–ª–∏ –¥–∞, —Ç–æ –∫–∞–∫ –¥–∞–≤–Ω–æ?"
    
    elif '–ª–∏—Ñ—Ç–∏–Ω–≥' in procedure:
        if questions_answered == 0:
            return "–ö–∞–∫–∏–µ –∑–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç? (–ª–∏—Ü–æ, —à–µ—è, –¥–µ–∫–æ–ª—å—Ç–µ, —Ä—É–∫–∏)"
        elif questions_answered == 1:
            return "–ö–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∫–æ–∂–∏ –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω—ã –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?"
    
    return "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –µ—â–µ –æ –≤–∞—à–∏—Ö –æ–∂–∏–¥–∞–Ω–∏—è—Ö –æ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã?"

def handle_epilation_details(message: str, session: Dict[str, Any]) -> str:
    """–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —ç–ø–∏–ª—è—Ü–∏–∏."""
    message_lower = message.lower()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—ã
    zones_keywords = {
        "–ø–æ–¥–º—ã—à–µ–∫": "–ø–æ–¥–º—ã—à–µ—á–Ω—ã–µ –≤–ø–∞–¥–∏–Ω—ã",
        "–±–∏–∫–∏–Ω–∏": "–∑–æ–Ω–∞ –±–∏–∫–∏–Ω–∏",
        "–≥–æ–ª–µ–Ω–∏": "–≥–æ–ª–µ–Ω–∏",
        "–Ω–æ–≥–∏": "–Ω–æ–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é",
        "–ª–∏—Ü–æ": "–ª–∏—Ü–æ",
        "–≤–µ—Ä—Ö–Ω—è—è –≥—É–±–∞": "–Ω–∞–¥ –≥—É–±–æ–π",
        "–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫": "–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫"
    }
    
    for keyword, zone in zones_keywords.items():
        if keyword in message_lower:
            session['zone'] = zone
            break
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ª–∞–∑–µ—Ä–∞
    if "–≥–∏–±—Ä–∏–¥" in message_lower or "innovation" in message_lower:
        session['laser_type'] = "–≥–∏–±—Ä–∏–¥–Ω—ã–π"
    elif "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç" in message_lower or "quanta" in message_lower:
        session['laser_type'] = "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    if "—Å–æ—á–∏" in message_lower:
        session['location'] = "–°–æ—á–∏"
    elif "–∞–¥–ª–µ—Ä" in message_lower:
        session['location'] = "–ê–¥–ª–µ—Ä"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    questions_answered = len(session.get('questions_answered', []))
    
    if questions_answered < 2:
        next_q = get_next_question(session)
        return next_q
    else:
        session['stage'] = 'contact_collection'
        return prepare_epilation_summary(session)

def prepare_epilation_summary(session: Dict[str, Any]) -> str:
    """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–≤–æ–¥–∫–∏ –ø–æ —ç–ø–∏–ª—è—Ü–∏–∏."""
    summary = "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:\n\n"
    
    if session.get('zone'):
        summary += f"üìç –ó–æ–Ω–∞: {session['zone']}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã
        if "–ø–æ–¥–º—ã—à–µ—á–Ω—ã–µ" in session['zone'].lower() or "–ø–æ–¥–º—ã—à–µ–∫" in session['zone'].lower():
            summary += "üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:\n"
            summary += "   ‚Ä¢ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ª–∞–∑–µ—Ä: 1100 —Ä—É–±\n"
            summary += "   ‚Ä¢ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π: 1400 —Ä—É–±\n"
    
    if session.get('laser_type'):
        laser_info = {
            "–≥–∏–±—Ä–∏–¥–Ω—ã–π": "Laser Innovation (–≥–∏–±—Ä–∏–¥–Ω—ã–π) - –±–æ–ª–µ–µ –º—è–≥–∫–∏–π, –±–æ–ª—å—à–µ —Å–µ–∞–Ω—Å–æ–≤ (8-12)",
            "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π": "Laser Quanta System (–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π) - –±–æ–ª–µ–µ –º–æ—â–Ω—ã–π, –º–µ–Ω—å—à–µ —Å–µ–∞–Ω—Å–æ–≤ (5-7)"
        }
        summary += f"üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ª–∞–∑–µ—Ä: {laser_info.get(session['laser_type'], session['laser_type'])}\n"
    
    if session.get('location'):
        summary += f"üè• –ö–ª–∏–Ω–∏–∫–∞: {session['location']}\n"
        if session['location'] == "–ê–¥–ª–µ—Ä":
            summary += "   (–í –ê–¥–ª–µ—Ä–µ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ª–∞–∑–µ—Ä)\n"
    
    summary += "\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω."
    
    return summary

def handle_skin_procedure_details(message: str, session: Dict[str, Any]) -> str:
    """–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –ø—Ä–æ—Ü–µ–¥—É—Ä –ø–æ —É—Ö–æ–¥—É –∑–∞ –∫–æ–∂–µ–π."""
    message_lower = message.lower()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–∂–∏
    skin_types = ["–∂–∏—Ä–Ω–∞—è", "—Å—É—Ö–∞—è", "–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–ø—Ä–æ–±–ª–µ–º–Ω–∞—è", "—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è"]
    for skin_type in skin_types:
        if skin_type in message_lower:
            session['skin_type'] = skin_type
            break
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã
    problems = ["–∞–∫–Ω–µ", "–ø—Ä—ã—â–∏", "—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–æ—Ä—ã", "—á–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏", "–ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è", "–∫—É–ø–µ—Ä–æ–∑", "–º–æ—Ä—â–∏–Ω—ã"]
    found_problems = []
    for problem in problems:
        if problem in message_lower:
            found_problems.append(problem)
    
    if found_problems:
        session['skin_problems'] = found_problems
    
    questions_answered = len(session.get('questions_answered', []))
    
    if questions_answered < 2:
        next_q = get_next_question(session)
        return next_q
    else:
        session['stage'] = 'contact_collection'
        return prepare_skin_procedure_summary(session)

def prepare_skin_procedure_summary(session: Dict[str, Any]) -> str:
    """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–≤–æ–¥–∫–∏ –ø–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –¥–ª—è –∫–æ–∂–∏."""
    summary = "‚úÖ –ü–æ–Ω—è–ª–∞ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é! –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n\n"
    
    if session.get('skin_type'):
        summary += f"üìù –¢–∏–ø –∫–æ–∂–∏: {session['skin_type']}\n"
    
    if session.get('skin_problems'):
        summary += f"üîç –ü—Ä–æ–±–ª–µ–º—ã: {', '.join(session['skin_problems'])}\n"
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–±–ª–µ–º
        recommendations = {
            "–∞–∫–Ω–µ": "–†–µ–∫–æ–º–µ–Ω–¥—É—é –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–µ–π (7000 —Ä—É–±)",
            "–ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è": "–ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ Lumeca (–æ—Ç 6000 —Ä—É–±)",
            "–∫—É–ø–µ—Ä–æ–∑": "–õ—É—á—à–µ –≤—Å–µ–≥–æ –ª–∞–∑–µ—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Å—É–¥–æ–≤ (1500 —Ä—É–±/–∫–≤.—Å–º)",
            "–º–æ—Ä—â–∏–Ω—ã": "–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –º–∏–∫—Ä–æ–∏–≥–æ–ª—å—á–∞—Ç—ã–π RF-–ª–∏—Ñ—Ç–∏–Ω–≥ (–æ—Ç 16500 —Ä—É–±) –∏–ª–∏ –±–æ—Ç—É–ª–æ—Ç–æ–∫—Å–∏–Ω (250 —Ä—É–±/–µ–¥)"
        }
        
        for problem, rec in recommendations.items():
            if problem in session['skin_problems']:
                summary += f"üí° {rec}\n"
                break
    
    summary += "\n–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–æ–º –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω."
    
    return summary

def handle_botox_details(message: str, session: Dict[str, Any]) -> str:
    """–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –±–æ—Ç–æ–∫—Å–∞."""
    message_lower = message.lower()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—ã
    zones = ["–ª–æ–±", "–º–µ–∂–±—Ä–æ–≤—å–µ", "–≥—É—Å–∏–Ω—ã–µ –ª–∞–ø–∫–∏", "—à–µ—è", "–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫"]
    found_zones = []
    for zone in zones:
        if zone in message_lower:
            found_zones.append(zone)
    
    if found_zones:
        session['zones'] = found_zones
    
    questions_answered = len(session.get('questions_answered', []))
    
    if questions_answered < 2:
        next_q = get_next_question(session)
        return next_q
    else:
        session['stage'] = 'contact_collection'
        
        summary = "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:\n\n"
        if session.get('zones'):
            summary += f"üìç –ó–æ–Ω—ã: {', '.join(session['zones'])}\n"
            summary += f"üíâ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü: {len(session['zones']) * 15-25} –µ–¥.\n"
            summary += f"üí∞ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {len(session['zones']) * 15 * 250} - {len(session['zones']) * 25 * 250} —Ä—É–±.\n"
        
        summary += "\n–¢–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤—Ä–∞—á –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\n"
        summary += "–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω."
        
        return summary

def handle_lifting_details(message: str, session: Dict[str, Any]) -> str:
    """–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –ª–∏—Ñ—Ç–∏–Ω–≥–∞."""
    message_lower = message.lower()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—ã
    zones = ["–ª–∏—Ü–æ", "—à–µ—è", "–¥–µ–∫–æ–ª—å—Ç–µ", "—Ä—É–∫–∏", "–∂–∏–≤–æ—Ç", "–±–µ–¥—Ä–∞"]
    found_zones = []
    for zone in zones:
        if zone in message_lower:
            found_zones.append(zone)
    
    if found_zones:
        session['zones'] = found_zones
    
    questions_answered = len(session.get('questions_answered', []))
    
    if questions_answered < 2:
        next_q = get_next_question(session)
        return next_q
    else:
        session['stage'] = 'contact_collection'
        
        summary = "‚úÖ –ü–æ–Ω—è–ª–∞! –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n\n"
        
        if session.get('zones'):
            summary += f"üìç –ó–æ–Ω—ã: {', '.join(session['zones'])}\n"
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º
            if "–ª–∏—Ü–æ" in session['zones'] or "—à–µ—è" in session['zones']:
                summary += "üí° –î–ª—è –ª–∏—Ü–∞ –∏ —à–µ–∏ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç:\n"
                summary += "   - SMAS-–ª–∏—Ñ—Ç–∏–Ω–≥ –æ—Ç 14000 —Ä—É–±\n"
                summary += "   - –ú–∏–∫—Ä–æ–∏–≥–æ–ª—å—á–∞—Ç—ã–π RF-–ª–∏—Ñ—Ç–∏–Ω–≥ –æ—Ç 16500 —Ä—É–±\n"
        
        summary += "\n–î–ª—è –ø–æ–¥–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è.\n"
        summary += "–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω."
        
        return summary

def should_move_to_contacts(message: str, session: Dict[str, Any]) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø–æ—Ä–∞ –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–±–æ—Ä—É –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
    """
    message_lower = message.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
    ready_keywords = [
        "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", 
        "–≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º", "—Ö–æ—á—É –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É",
        "–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∑–∞–ø–∏—Å—å", "—Ö–æ—á—É —Å–¥–µ–ª–∞—Ç—å", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è",
        "–¥–∞–≤–∞–π—Ç–µ", "—Å–æ–≥–ª–∞—Å–µ–Ω", "–æ–∫", "—Ö–æ—Ä–æ—à–æ", "–∏–¥–µ–º—Ç–µ", "—Ö–æ—Ç–µ–ª –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
    ]
    
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –∑–∞–ø–∏—Å–∏
    if any(keyword in message_lower for keyword in ready_keywords):
        return True
    
    # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    contact_patterns = [
        r'\d{10,11}',
        r'[\+7]?[-\s]?\(?\d{3}\)?[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2,3}',
        r'–º–µ–Ω—è\s+–∑–æ–≤—É—Ç',
        r'–∏–º—è\s+',
        r'—Ç–µ–ª–µ—Ñ–æ–Ω'
    ]
    
    for pattern in contact_patterns:
        if re.search(pattern, message_lower):
            return True
    
    # –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ
    if session.get('message_count', 0) >= 5:
        return True
    
    return False

def handle_contact_collection(message: str, session: Dict[str, Any]) -> str:
    """
    –≠—Ç–∞–ø 4: –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
    """
    print(f"üîç –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è: '{message}'")
    
    # –ò—â–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω)
    phone_pattern = r'[\+7]?[-\s]?\(?\d{3}\)?[-\s]?\d{3}[-\s]?\d{2}[-\s]?\d{2,3}'
    phone_matches = re.findall(phone_pattern, message)
    
    # –¢–∞–∫–∂–µ –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ 11 —Ü–∏—Ñ—Ä –ø–æ–¥—Ä—è–¥
    if not phone_matches:
        phone_pattern2 = r'\b\d{10,11}\b'
        phone_matches = re.findall(phone_pattern2, message)
    
    # –£–¥–∞–ª—è–µ–º –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if phone_matches:
        clean_phone = re.sub(r'\D', '', phone_matches[0])
        if 10 <= len(clean_phone) <= 11:
            session['phone'] = clean_phone
            print(f"üìû –ù–∞–π–¥–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω: {session['phone']}")
    
    # –ò—â–µ–º –∏–º—è - –£–ü–†–û–©–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê
    # –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–≤–∞
    words = re.findall(r'[–ê-–Ø–Å–∞-—è—ëA-Za-z]+', message)
    
    # –ò—â–µ–º —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã (–∏–º–µ–Ω–∞)
    russian_words = [word for word in words if re.match(r'^[–ê-–Ø–Å][–∞-—è—ë]*$', word)]
    
    if russian_words and not session['name']:
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã –∫–∞–∫ –∏–º—è
        session['name'] = russian_words[0]
        print(f"üë§ –ù–∞–π–¥–µ–Ω–æ –∏–º—è: {session['name']}")
    
    # –ï—Å–ª–∏ –∏–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if not session['name'] and len(session.get('text_parts', [])) > 0:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è
        for prev_msg in session['text_parts'][-2:]:
            prev_words = re.findall(r'[–ê-–Ø–Å–∞-—è—ëA-Za-z]+', prev_msg)
            prev_russian_words = [word for word in prev_words if re.match(r'^[–ê-–Ø–Å][–∞-—è—ë]*$', word)]
            if prev_russian_words:
                session['name'] = prev_russian_words[0]
                print(f"üë§ –ù–∞–π–¥–µ–Ω–æ –∏–º—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {session['name']}")
                break
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å
    has_name = bool(session['name'])
    has_phone = bool(session['phone'])
    
    if has_name and has_phone:
        return "–°–ø–∞—Å–∏–±–æ! –°–µ–π—á–∞—Å –ø–µ—Ä–µ–¥–∞–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    elif has_name and not has_phone:
        return f"–°–ø–∞—Å–∏–±–æ, {session['name']}! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏."
    elif has_phone and not has_name:
        return f"–°–ø–∞—Å–∏–±–æ! –í–∏–∂—É –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω {session['phone']}. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"
    else:
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –ø—Ä–æ—Å–∏–º –æ–±–∞
        return "–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏. –£–∫–∞–∂–∏—Ç–µ –∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
