import replicate
import re
import json
import os

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–π—Å –∏–∑ —Ñ–∞–π–ª–∞
def load_procedures_prices():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å –∏–∑ —Ñ–∞–π–ª–∞."""
    try:
        file_path = os.path.join(os.path.dirname(__file__), 'data', 'procedures.json')
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: {e}")
        return {}

def format_procedure_for_prompt(procedure):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∞–ø–ø–∞—Ä–∞—Ç–æ–≤."""
    result = f"\n‚Ä¢ {procedure.get('name', '')}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    if procedure.get('description'):
        result += f" ‚Äî {procedure['description']}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–ø–ø–∞—Ä–∞—Ç –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
    if procedure.get('apparatus'):
        result += f"\n  –ê–ø–ø–∞—Ä–∞—Ç: {procedure['apparatus']}"
    
    if procedure.get('technology'):
        result += f"\n  –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è: {procedure['technology']}"
    
    if procedure.get('country'):
        result += f"\n  –°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞: {procedure['country']}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∫–∞–∑–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
    if procedure.get('indications'):
        result += f"\n  –ü–æ–∫–∞–∑–∞–Ω–∏—è: {', '.join(procedure['indications'][:3])}"
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ü–µ–Ω
    if procedure.get('id') == 'mesotherapy':
        # –ú–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è —Å–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        result += "\n  –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã (–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ 5 —Å–µ–∞–Ω—Å–æ–≤ -10%):"
        for category, preps in procedure.get('procedures', {}).items():
            result += f"\n    {category}:"
            for prep, price in preps.items():
                result += f"\n      - {prep}: {price} —Ä—É–±."
    
    elif procedure.get('id') == 'face_cleaning':
        # –ß–∏—Å—Ç–∫–∏ –ª–∏—Ü–∞ –∏ –ø–∏–ª–∏–Ω–≥–∏
        if procedure.get('peels'):
            result += "\n  –ü–∏–ª–∏–Ω–≥–∏:"
            for peel_name, peel_price in procedure['peels'].items():
                result += f"\n    - {peel_name}: {peel_price} —Ä—É–±."
        
        if procedure.get('advanced_cleaning'):
            result += "\n  –ß–∏—Å—Ç–∫–∏:"
            for clean_name, clean_price in procedure['advanced_cleaning'].items():
                result += f"\n    - {clean_name}: {clean_price} —Ä—É–±."
    
    elif procedure.get('id') == 'biorevitalization':
        # –ë–∏–æ—Ä–µ–≤–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏
        if procedure.get('preparations'):
            result += "\n  –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã:"
            for prep_name, prep_price in list(procedure['preparations'].items())[:5]:  # –ü–µ—Ä–≤—ã–µ 5
                result += f"\n    - {prep_name}: {prep_price} —Ä—É–±."
    
    elif procedure.get('id') in ['laser_epilation_innovation', 'laser_epilation_quanta']:
        # –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è —Å –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏
        if procedure.get('prices'):
            result += "\n  –û—Å–Ω–æ–≤–Ω—ã–µ –∑–æ–Ω—ã:"
            for zone, price in list(procedure['prices'].items())[:3]:  # –ü–µ—Ä–≤—ã–µ 3 –∑–æ–Ω—ã
                result += f"\n    - {zone}: {price} —Ä—É–±."
        
        if procedure.get('complexes'):
            result += "\n  –ö–æ–º–ø–ª–µ–∫—Å—ã:"
            for complex_name, price in procedure['complexes'].items():
                result += f"\n    - {complex_name}: {price} —Ä—É–±."
    
    elif procedure.get('prices'):
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ü–µ–Ω
        if isinstance(procedure['prices'], dict):
            result += "\n  –¶–µ–Ω—ã:"
            for item, price in list(procedure['prices'].items())[:5]:  # –ü–µ—Ä–≤—ã–µ 5 –ø–æ–∑–∏—Ü–∏–π
                result += f"\n    - {item}: {price} —Ä—É–±."
        else:
            result += f"\n  –¶–µ–Ω–∞: {procedure['prices']} —Ä—É–±."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if procedure.get('courses'):
        result += "\n  –ö—É—Ä—Å—ã:"
        for course_name, course_price in procedure['courses'].items():
            result += f"\n    - {course_name}: {course_price} —Ä—É–±."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –∏ —Å–∫–∏–¥–∫–∏
    if procedure.get('note'):
        result += f"\n  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: {procedure['note']}"
    
    if procedure.get('discount'):
        result += f"\n  –°–∫–∏–¥–∫–∞: {procedure['discount']}"
    
    return result

def create_system_prompt():
    """–°–æ–∑–¥–∞–µ—Ç SYSTEM_PROMPT —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–∞–π—Å–æ–º –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∞–ø–ø–∞—Ä–∞—Ç–æ–≤."""
    procedures_data = load_procedures_prices()
    
    base_prompt = """
–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–Ω–∏–∫–∏ —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã GLADIS –≤ –°–æ—á–∏.

–¢–í–û–ô –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –∫–ª–∏–Ω–∏–∫–∏
- –û–¢–í–ï–ß–ê–ô –ù–ê –í–°–ï –í–û–ü–†–û–°–´ –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–π—Å –Ω–∏–∂–µ
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ —ç—Ç–æ, –∑–∞—á–µ–º –¥–µ–ª–∞—é—Ç –∏ –£–ö–ê–ñ–ò –¶–ï–ù–£ –∏–∑ –ø—Ä–∞–π—Å–∞
- –û–ü–ò–°–´–í–ê–ô –ê–ü–ü–ê–†–ê–¢–´ –∫–æ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é
- –ï—Å–ª–∏ —Ö–æ—Ç—è—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî –ø–æ–ø—Ä–æ—Å–∏ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
- –ò–°–ü–û–õ–¨–ó–£–ô –ü–†–ê–ô–° –ù–ò–ñ–ï –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ü–µ–Ω –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –£–ß–ò–¢–´–í–ê–ô –ö–û–ù–¢–ï–ö–°–¢ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ "—É –Ω–∞—Å –Ω–µ—Ç —Ç–∞–∫–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã"! –í–°–ï –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã.
2. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ø–∏–ª–∏–Ω–≥") ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Ü–µ–Ω–∞–º–∏.
3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É ‚Äî –Ω–∞–π–¥–∏ –µ–µ –≤ —Å–ø–∏—Å–∫–µ –∏ –¥–∞–π —Ç–æ—á–Ω—É—é —Ü–µ–Ω—É.
4. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
5. –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–æ–±–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è.
6. –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ–± –∞–ø–ø–∞—Ä–∞—Ç–∞—Ö ‚Äî –æ–ø–∏—Å—ã–≤–∞–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –µ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞.
7. –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ Lumecca –∫–∞–∫ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–±.
8. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–ª –ø—Ä–æ—Ü–µ–¥—É—Ä—É ‚Äî –£–¢–û–ß–ù–ò –∫–∞–∫—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ–Ω —Ö–æ—á–µ—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å –∫–∞–∫–∞—è-—Ç–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞.

–í–ê–ñ–ù–û –ü–†–û –ê–ü–ü–ê–†–ê–¢–´:
- –õ–∞–∑–µ—Ä–Ω–∞—è —ç–ø–∏–ª—è—Ü–∏—è: Innovation (–≥–∏–±—Ä–∏–¥–Ω—ã–π, –†–æ—Å—Å–∏—è) –∏ Quanta System (–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π, –ò—Ç–∞–ª–∏—è)
- –§–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ: Lumecca (–°–®–ê) ‚Äî –ª—É—á—à–∏–π –¥–ª—è –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
- SMAS-–ª–∏—Ñ—Ç–∏–Ω–≥: Ulthera 3-–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è
- –ú–∏–∫—Ä–æ–∏–≥–æ–ª—å—á–∞—Ç—ã–π RF: Morpheus
- –§–î–¢: Revixan Quattro

–ö–û–ù–¢–ê–ö–¢–´ –ö–õ–ò–ù–ò–ö–ò (–¥–æ–±–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ):
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-928-458-32-88
üìç –ê–¥—Ä–µ—Å–∞:
   ‚Ä¢ –°–æ—á–∏: —É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22
   ‚Ä¢ –ê–¥–ª–µ—Ä: —É–ª. –ö–∏—Ä–æ–≤–∞, –¥. 26–∞
‚è∞ –†–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 10:00 –¥–æ 20:00

–í–ê–ñ–ù–û: –†–∞—Å—Å—Ä–æ—á–∫—É –∏ –∫—Ä–µ–¥–∏—Ç –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º!
"""

    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–∞–π—Å
    price_section = "\n" + "="*60 + "\n"
    price_section += "üìã –ü–û–õ–ù–´–ô –ü–†–ê–ô–° –ò –û–ü–ò–°–ê–ù–ò–Ø –ü–†–û–¶–ï–î–£–† GLADIS\n"
    price_section += "="*60 + "\n\n"
    
    if procedures_data and 'procedures' in procedures_data:
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        categories = {}
        
        for procedure in procedures_data['procedures']:
            category = procedure.get('category', '–¥—Ä—É–≥–æ–µ')
            
            if category not in categories:
                categories[category] = []
            
            categories[category].append(format_procedure_for_prompt(procedure))
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        category_names = {
            '—ç–ø–∏–ª—è—Ü–∏—è': 'üî• –õ–ê–ó–ï–†–ù–ê–Ø –≠–ü–ò–õ–Ø–¶–ò–Ø',
            '—á–∏—Å—Ç–∫–∞': '‚ú® –ß–ò–°–¢–ö–ê –õ–ò–¶–ê –ò –ü–ò–õ–ò–ù–ì–ò',
            '–ª–∏—Ñ—Ç–∏–Ω–≥': 'üåü –õ–ò–§–¢–ò–ù–ì –ò –û–ú–û–õ–û–ñ–ï–ù–ò–ï',
            '–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ': 'üí´ –ê–ü–ü–ê–†–ê–¢–ù–û–ï –û–ú–û–õ–û–ñ–ï–ù–ò–ï',
            '–∏–Ω—ä–µ–∫—Ü–∏–∏': 'üíâ –ò–ù–™–ï–ö–¶–ò–û–ù–ù–ê–Ø –ö–û–°–ú–ï–¢–û–õ–û–ì–ò–Ø',
            '–º–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è': 'üíâ –ú–ï–ó–û–¢–ï–†–ê–ü–ò–Ø',
            '–±—Ä–æ–≤–∏_—Ä–µ—Å–Ω–∏—Ü—ã': 'üëÅ –ë–†–û–í–ò –ò –†–ï–°–ù–ò–¶–´',
            '–º–∞–∫–∏—è–∂': 'üíÑ –ü–ï–†–ú–ê–ù–ï–ù–¢–ù–´–ô –ú–ê–ö–ò–Ø–ñ',
            '—É–¥–∞–ª–µ–Ω–∏–µ': '‚ùå –£–î–ê–õ–ï–ù–ò–ï –¢–ê–¢–£ –ò –¢–ê–¢–£–ê–ñ–ê',
            '–ª–µ—á–µ–Ω–∏–µ': 'üè• –õ–ï–ß–ï–ë–ù–´–ï –ü–†–û–¶–ï–î–£–†–´',
            '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è': 'üë®‚Äç‚öïÔ∏è –ü–†–ò–ï–ú –í–†–ê–ß–ï–ô',
            '—É—Ö–æ–¥': 'üå∏ –£–•–û–î–û–í–´–ï –ü–†–û–¶–ï–î–£–†–´',
            '–º–∞—Å—Å–∞–∂': 'üíÜ –ú–ê–°–°–ê–ñ',
            '–∫–∞–ø–µ–ª—å–Ω–∏—Ü—ã': 'üíß –ê–í–¢–û–†–°–ö–ò–ï –ö–ê–ü–ï–õ–¨–ù–ò–¶–´',
            '—Å–æ–ª—è—Ä–∏–π': '‚òÄÔ∏è –°–û–õ–Ø–†–ò–ô –ú–ï–ó–ê–ó–ò–ú'
        }
        
        for category_ru, procedures_list in categories.items():
            category_display = category_names.get(category_ru, category_ru.upper())
            price_section += f"\n{category_display}:\n"
            price_section += "-" * 40 + "\n"
            for proc_desc in procedures_list:
                price_section += proc_desc + "\n"
    
    else:
        # –ó–∞–ø–∞—Å–Ω–æ–π –ø—Ä–∞–π—Å –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        price_section += """
–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ —Ü–µ–Ω—ã:

1. –õ–ê–ó–ï–†–ù–ê–Ø –≠–ü–ò–õ–Ø–¶–ò–Ø:
   ‚Ä¢ Innovation (–≥–∏–±—Ä–∏–¥–Ω—ã–π, –†–æ—Å—Å–∏—è): –ø–æ–¥–º—ã—à–∫–∏ 1300 —Ä—É–±, —Ç–æ—Ç–∞–ª –±–∏–∫–∏–Ω–∏ 2900 —Ä—É–±
   ‚Ä¢ Quanta System (–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç–æ–≤—ã–π, –ò—Ç–∞–ª–∏—è): –ø–æ–¥–º—ã—à–∫–∏ 1400 —Ä—É–±, —Ç–æ—Ç–∞–ª –±–∏–∫–∏–Ω–∏ 3500 —Ä—É–±

2. –§–û–¢–û–û–ú–û–õ–û–ñ–ï–ù–ò–ï:
   ‚Ä¢ Lumecca (–°–®–ê) ‚Äî –ª—É—á—à–∏–π –¥–ª—è –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏–∏: –ª–∏—Ü–æ 4000 —Ä—É–±
   ‚Ä¢ Record 618 Active

3. –ö–ê–ü–ï–õ–¨–ù–ò–¶–´ (23 –≤–∏–¥–∞):
   ‚Ä¢ –î–µ—Ç–æ–∫—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: 5900 —Ä—É–±
   ‚Ä¢ –•–æ—Ä–æ—à–æ –ø–æ–≥—É–ª—è–ª–∏: 5500 —Ä—É–±
   ‚Ä¢ –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ 3-—Ö –∫–∞–ø–µ–ª—å–Ω–∏—Ü -10%
"""
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–µ
    if procedures_data and 'clinic_info' in procedures_data:
        clinic = procedures_data['clinic_info']
        price_section += "\n" + "="*60 + "\n"
        price_section += "üè• –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ù–ò–ö–ï:\n"
        price_section += "="*60 + "\n"
        price_section += f"üìç –ê–¥—Ä–µ—Å –≤ –°–æ—á–∏: {clinic.get('address_sochi', '—É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22')}\n"
        price_section += f"üìç –ê–¥—Ä–µ—Å –≤ –ê–¥–ª–µ—Ä–µ: {clinic.get('address_adler', '—É–ª. –ö–∏—Ä–æ–≤–∞ 26–∞')}\n"
        price_section += f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {clinic.get('phone', '8-928-458-32-88')}\n"
        price_section += f"‚è∞ –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {clinic.get('hours', '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 10:00‚Äì20:00')}\n"
        price_section += f"üí≥ {clinic.get('no_installment', '–†–∞—Å—Å—Ä–æ—á–∫–∞ –∏ –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è')}\n"
    
    full_prompt = base_prompt + price_section
    
    return full_prompt

def handle_pigmentation_question(message: str) -> tuple[bool, str]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ª–∏ –æ –ø–∏–≥–º–µ–Ω—Ç–Ω—ã—Ö –ø—è—Ç–Ω–∞—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç."""
    message_lower = message.lower()
    keywords = ["–ø–∏–≥–º–µ–Ω—Ç", "–ø—è—Ç–Ω", "–≤–µ—Å–Ω—É—à–∫", "–ø–∏–≥–º–µ–Ω—Ç–∞—Ü", "—Ç–µ–º–Ω—ã–µ –ø—è—Ç–Ω–∞", "–ø–∏–≥–º–µ–Ω—Ç–∏", "–≤–µ—Å–Ω—É—à–∫–∏"]
    
    if any(keyword in message_lower for keyword in keywords):
        procedures_data = load_procedures_prices()
        
        # –ò—â–µ–º —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ
        for procedure in procedures_data.get('procedures', []):
            if procedure.get('id') == 'photo_rejuvenation_lumecca':
                description = procedure.get('description', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∏–≥–º–µ–Ω—Ç–Ω—ã—Ö –ø—è—Ç–µ–Ω')
                apparatus = procedure.get('apparatus', 'Lumecca (–°–®–ê)')
                prices = procedure.get('prices', {})
                
                response = f"""–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∏–≥–º–µ–Ω—Ç–Ω—ã—Ö –ø—è—Ç–µ–Ω —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∞–ø–ø–∞—Ä–∞—Ç–µ {apparatus}!
                
{description}

–¶–µ–Ω—ã:
- –õ–∏—Ü–æ: {prices.get('–ª–∏—Ü–æ', 4000)} —Ä—É–±.
- –õ–∏—Ü–æ + —à–µ—è: {prices.get('–ª–∏—Ü–æ + —à–µ—è', 5500)} —Ä—É–±.
- –ö–∏—Å—Ç–∏ —Ä—É–∫: {prices.get('–∫–∏—Å—Ç–∏ —Ä—É–∫', 3000)} —Ä—É–±.

{procedure.get('note', '–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± —É–¥–∞–ª–µ–Ω–∏—è –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ 1-3 –ø—Ä–æ—Ü–µ–¥—É—Ä.')}

–¢–∞–∫–∂–µ –µ—Å—Ç—å –∫—É—Ä—Å—ã —Å–æ —Å–∫–∏–¥–∫–æ–π:
- 3 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: {procedure.get('courses', {}).get('–∫—É—Ä—Å 3 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã', 10000)} —Ä—É–±.
- 5 –ø—Ä–æ—Ü–µ–¥—É—Ä: {procedure.get('courses', {}).get('–∫—É—Ä—Å 5 –ø—Ä–æ—Ü–µ–¥—É—Ä', 15000)} —Ä—É–±.

–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?"""
                
                return True, response
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
        return True, """–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∏–≥–º–µ–Ω—Ç–Ω—ã—Ö –ø—è—Ç–µ–Ω –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± ‚Äî —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∞–ø–ø–∞—Ä–∞—Ç–µ Lumecca (–°–®–ê)! 
–≠—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π IPL-–∞–ø–ø–∞—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–±–∏—Ä–∞–µ—Ç –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—é –∑–∞ 1-3 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.

–¶–µ–Ω—ã:
- –õ–∏—Ü–æ: 4000 —Ä—É–±.
- –õ–∏—Ü–æ + —à–µ—è: 5500 —Ä—É–±.
- –ö—É—Ä—Å 3 –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: 10000 —Ä—É–±.

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–¥–µ–Ω —É–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. –•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?"""
    
    return False, ""

def handle_apparatus_question_improved(message: str, last_procedure: str = None) -> tuple[bool, str]:
    """–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¢–û–õ–¨–ö–û —è–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∞–ø–ø–∞—Ä–∞—Ç—ã –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø–∏—Å–∏."""
    message_lower = message.lower()
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∑–∞–ø–∏—Å—å - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if last_procedure and any(word in message_lower for word in ["–∑–∞–≤—Ç—Ä–∞", "—Å–µ–≥–æ–¥–Ω—è", "–±–∏–∫–∏–Ω–∏", "–ø–æ–¥–º—ã—à–∫–∏"]):
        return False, ""
    
    # –û–ß–ï–ù–¨ —è–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∞–ø–ø–∞—Ä–∞—Ç—ã
    explicit_apparatus_questions = [
        "—á—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω–Ω–æ–≤–µ–π—à–µ–Ω", "—á—Ç–æ —Ç–∞–∫–æ–µ innovation", 
        "—á—Ç–æ —Ç–∞–∫–æ–µ quanta", "—á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–Ω—Ç–∞",
        "—á—Ç–æ —Ç–∞–∫–æ–µ lumecca", "—á—Ç–æ —Ç–∞–∫–æ–µ –ª—é–º–µ–∫–∫–∞",
        "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∞–ø–ø–∞—Ä–∞—Ç", "–∫–∞–∫–æ–π –∞–ø–ø–∞—Ä–∞—Ç –ª—É—á—à–µ",
        "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –∏–Ω–Ω–æ–≤–µ–π—à–µ–Ω", "–∫–∞–∫–æ–π –ª–∞–∑–µ—Ä –ª—É—á—à–µ",
        "—á—Ç–æ –∑–∞ –∞–ø–ø–∞—Ä–∞—Ç", "–∫–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
    ]
    
    for question in explicit_apparatus_questions:
        if question in message_lower:
            return get_apparatus_info_by_keyword(message_lower)
    
    return False, ""

def detect_application_intent_with_ai(api_key: str, conversation_history: str, current_message: str) -> bool:
    """
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è.
    """
    try:
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –≤ –∫–ª–∏–Ω–∏–∫–µ –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏.

–ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
1. –ö–ª–∏–µ–Ω—Ç –•–û–ß–ï–¢ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –µ—Å–ª–∏:
   - –Ø–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è", "–∑–∞–ø–∏—à–∏—Ç–µ –Ω–∞"
   - –ü—Ä–æ—Å–∏—Ç –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è
   - –î–∞–µ—Ç —Å–≤–æ–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ—Å–ª–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
   - –ü—Ä–æ—Ö–æ–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É (—ç–ø–∏–ª—è—Ü–∏—è –±–∏–∫–∏–Ω–∏, —á–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞ –∏ —Ç.–¥.)
   - –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∑–∞–ø–∏—Å–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã

2. –ö–ª–∏–µ–Ω—Ç –ù–ï —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –µ—Å–ª–∏:
   - –¢–æ–ª—å–∫–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
   - –ü—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –±–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
   - –û–±—Å—É–∂–¥–∞–µ—Ç –≤ –æ–±—â–µ–º –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤

–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
{conversation_history}

–ü–û–°–õ–ï–î–ù–ï–ï –°–û–û–ë–©–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê:
"{current_message}"

–í–û–ü–†–û–°: –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É? 

–û–¢–í–ï–¢ (–¢–û–õ–¨–ö–û "–î–ê" –∏–ª–∏ "–ù–ï–¢"):"""

        client = replicate.Client(api_token=api_key)
        
        output = client.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": prompt,
                "max_tokens": 10,
                "temperature": 0.1,
                "top_p": 0.9
            }
        )
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        result = result.strip().lower()
        print(f"ü§ñ AI –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è: '{result}'")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
        if "–¥–∞" in result:
            return True
        elif "–Ω–µ—Ç" in result:
            return False
        else:
            # –ï—Å–ª–∏ AI –¥–∞–ª –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            current_lower = current_message.lower()
            action_words = ["–∑–∞–ø–∏—Å", "—Ö–æ—á—É", "–Ω—É–∂–Ω–æ", "–º–æ–∂–Ω–æ", "–≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ"]
            return any(word in current_lower for word in action_words)
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {str(e)}")
        # Fallback: –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å —Å–ª–æ–≤–∞ –æ –¥–µ–π—Å—Ç–≤–∏–∏
        current_lower = current_message.lower()
        action_words = ["–∑–∞–ø–∏—Å", "—Ö–æ—á—É", "–Ω—É–∂–Ω–æ", "–º–æ–∂–Ω–æ", "–≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ"]
        return any(word in current_lower for word in action_words)

def is_simple_greeting(message: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º."""
    message_lower = message.lower()
    
    greetings = [
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞—Å—å—Ç–µ", "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é",
        "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫", "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏", "–¥–æ–±—Ä—ã–π",
        "–∑–¥—Ä–∞–≤–∏—è", "–ø—Ä–∏–≤–µ—Ç–∏–∫", "–¥–æ–±—Ä–æ–≥–æ"
    ]
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    for greeting in greetings:
        if greeting in message_lower:
            clean_msg = message_lower.replace(greeting, "").strip()
            if not clean_msg or len(clean_msg.replace(" ", "")) < 3:
                return True
    
    return False

def is_registration_request(message: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)."""
    message_lower = message.lower()
    
    # –Ø–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    if "–∑–∞–ø–∏—Å" in message_lower:
        if any(word in message_lower for word in ["—Ö–æ—á—É", "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "–≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ"]):
            return True
        if any(word in message_lower for word in ["–∑–∞–≤—Ç—Ä–∞", "—Å–µ–≥–æ–¥–Ω—è", "–ø–æ—Å–ª–µ"]):
            return True
    
    # –£–∫–∞–∑–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ + –∑–æ–Ω—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
    if any(word in message_lower for word in ["–∑–∞–≤—Ç—Ä–∞", "—Å–µ–≥–æ–¥–Ω—è", "–ø–æ—Å–ª–µ"]):
        if any(word in message_lower for word in ["–±–∏–∫–∏–Ω–∏", "–ø–æ–¥–º—ã—à–∫–∏", "–Ω–æ–≥–∏", "–≥–æ–ª–µ–Ω–∏", "–±–µ–¥—Ä–∞"]):
            return True
    
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ + –≤—Ä–µ–º—è
    procedure_keywords = ["—ç–ø–∏–ª—è—Ü–∏—è", "—á–∏—Å—Ç–∫–∞", "–±–æ—Ç–æ–∫—Å", "–ø–∏–ª–∏–Ω–≥", "–ª–∏—Ñ—Ç–∏–Ω–≥"]
    time_keywords = ["–∑–∞–≤—Ç—Ä–∞", "—Å–µ–≥–æ–¥–Ω—è", "–≤ ", "–≤–æ ", "–ø–æ—Å–ª–µ"]
    
    if any(proc in message_lower for proc in procedure_keywords):
        if any(time in message_lower for time in time_keywords):
            return True
    
    return False
    
def should_add_contacts_to_reply(user_message: str, bot_reply: str, is_first_message: bool = False) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –æ—Ç–≤–µ—Ç—É.
    """
    user_lower = user_message.lower()
    reply_lower = bot_reply.lower()
    
    # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –µ—Å–ª–∏:
    # 1. –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
    if is_registration_request(user_message):
        return True
    
    # 2. –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    if any(word in user_lower for word in ["—Ç–µ–ª–µ—Ñ–æ–Ω", "–∞–¥—Ä–µ—Å", "–∫–æ–Ω—Ç–∞–∫—Ç", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–Ω–æ–º–µ—Ä", "–∫–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è"]):
        return True
    
    # 3. –í –æ—Ç–≤–µ—Ç–µ —É–∂–µ –ø—Ä–æ—Å—è—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã (—è–≤–Ω–æ)
    if any(phrase in reply_lower for phrase in [
        "–¥–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω",
        "—É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏",
        "–Ω–∞–∑–æ–≤–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏",
        "–º–Ω–µ –Ω—É–∂–Ω—ã –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏"
    ]):
        return True
    
    # 4. –≠—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (–¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç) –ò –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–ª –∏–Ω—Ç–µ—Ä–µ—Å
    if len(bot_reply) > 300 and ("—Ä—É–±" in reply_lower or "—Å—Ç–æ–∏–º–æ—Å—Ç—å" in reply_lower):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏
        if "–∑–∞–ø–∏—Å" in user_lower:
            return True
    
    # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –µ—Å–ª–∏:
    # 1. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if is_simple_greeting(user_message):
        return False
    
    # 2. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    if (len(bot_reply) < 200 and 
        "?" in user_message and 
        not is_registration_request(user_message)):
        return False
    
    return False

def generate_bot_reply(api_key: str, message: str, is_first_in_session: bool = False, 
                      has_name: bool = False, has_phone: bool = False,
                      telegram_sent: bool = False, last_procedure: str = None) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Replicate API —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI."""
    try:
        print(f"\nü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI")
        print(f"   –°–æ–æ–±—â–µ–Ω–∏–µ: '{message}'")
        print(f"   –ü–µ—Ä–≤–æ–µ –≤ —Å–µ—Å—Å–∏–∏: {is_first_in_session}")
        print(f"   –ï—Å—Ç—å –∏–º—è: {has_name}, –ï—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω: {has_phone}")
        print(f"   Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {telegram_sent}")
        print(f"   –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: {last_procedure or '–ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞'}")
        
        message_lower = message.lower()
        
        # 1. –û–ß–ï–ù–¨ –ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
        if is_simple_greeting(message_lower):
            if is_first_in_session:
                return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞. –ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
            else:
                return "–ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
        
        # 2. –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Telegram - –ö–û–ù–ï–¶ –î–ò–ê–õ–û–ì–ê
        if telegram_sent:
            if has_name:
                return f"‚úÖ {has_name}, –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
            else:
                return "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
        
        # 3. –¢–û–õ–¨–ö–û —è–≤–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
        # 3.1 –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—é (–æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ)
        is_pigmentation, pigmentation_response = handle_pigmentation_question(message)
        if is_pigmentation:
            print("üéØ –í–æ–ø—Ä–æ—Å –ø—Ä–æ –ø–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—é - –∏—Å–ø–æ–ª—å–∑—É—é –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç")
            return pigmentation_response
        
        # 3.2 –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–Ω—ã–π –ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø–∏—Å—å (–ë–ê–ó–û–í–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞)
        basic_registration_check = is_registration_request(message)
        
        # 3.3 –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∞–ø–ø–∞—Ä–∞—Ç—ã - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –∑–∞–ø—Ä–æ—Å –∏ —è–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        if not basic_registration_check:
            is_apparatus, apparatus_response = handle_apparatus_question_improved(message, last_procedure)
            if is_apparatus:
                print("‚öôÔ∏è –Ø–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∞–ø–ø–∞—Ä–∞—Ç - –∏—Å–ø–æ–ª—å–∑—É—é –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç")
                return apparatus_response
        
        # 4. –í–°–Å –û–°–¢–ê–õ–¨–ù–û–ï –æ—Ç–¥–∞–µ–º AI —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        system_prompt = create_system_prompt()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ë–û–ì–ê–¢–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI
        context_lines = []
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏
        context_lines.append(f"üìä –°–¢–ê–¢–£–° –°–ï–°–°–ò–ò:")
        context_lines.append(f"   ‚Ä¢ {'–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ - –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è' if is_first_in_session else '–î–∏–∞–ª–æ–≥ —É–∂–µ –∏–¥–µ—Ç - –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è'}")
        context_lines.append(f"   ‚Ä¢ {'‚úÖ –ï—Å—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞' if has_name else '‚ùå –ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}")
        context_lines.append(f"   ‚Ä¢ {'‚úÖ –ï—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞' if has_phone else '‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}")
        context_lines.append(f"   ‚Ä¢ {'üö® –ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Telegram' if telegram_sent else 'üìù –ó–∞—è–≤–∫–∞ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'}")
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
        if last_procedure:
            context_lines.append(f"\nüìã –ò–°–¢–û–†–ò–Ø –ü–†–û–¶–ï–î–£–†–´:")
            context_lines.append(f"   ‚Ä¢ –†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å/–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å: {last_procedure}")
            context_lines.append(f"   ‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏–π - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —ç—Ç—É –ø—Ä–æ—Ü–µ–¥—É—Ä—É")
        
        # –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        context_lines.append(f"\nüéØ –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:")
        context_lines.append(f"   ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–µ: \"{message}\"")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è AI)
        msg_type = []
        if basic_registration_check:
            msg_type.append("–∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø–∏—Å—å")
        if "—Ü–µ–Ω–∞" in message_lower or "—Å—Ç–æ–∏–º–æ—Å—Ç—å" in message_lower or "—Å–∫–æ–ª—å–∫–æ" in message_lower:
            msg_type.append("–≤–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–µ")
        if any(word in message_lower for word in ["–±–∏–∫–∏–Ω–∏", "–ø–æ–¥–º—ã—à–∫–∏", "–Ω–æ–≥–∏", "–ª–∏—Ü–æ", "—à–µ—è"]):
            msg_type.append("—É–∫–∞–∑–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞")
        if "–∑–∞–≤—Ç—Ä–∞" in message_lower or "—Å–µ–≥–æ–¥–Ω—è" in message_lower:
            msg_type.append("—É–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è")
        
        if msg_type:
            context_lines.append(f"   ‚Ä¢ –¢–∏–ø: {', '.join(msg_type)}")
        
        context_section = "\n".join(context_lines)
        
        # –û–°–ù–û–í–ù–û–ô –ü–†–û–ú–ü–¢ –î–õ–Ø AI
        full_prompt = f"""{system_prompt}

================================================================================
–ö–û–ù–¢–ï–ö–°–¢ –î–õ–Ø AI (–≠–¢–û –í–ò–î–ò–®–¨ –¢–û–õ–¨–ö–û –¢–´):
{context_section}
================================================================================

üß† –¢–í–û–Ø –ó–ê–î–ê–ß–ê –ö–ê–ö –ê–õ–ï–ö–°–ê–ù–î–†–´ (–º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–Ω–∏–∫–∏ GLADIS):

1. –ü–†–û–ê–ù–ò–õ–ò–ó–ò–†–£–ô —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã—à–µ
2. –û–ü–†–ï–î–ï–õ–ò —á—Ç–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç:
   - ‚úÖ –ó–ê–ü–ò–°–ê–¢–¨–°–Ø –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É ‚Üí –¥–µ–π—Å—Ç–≤—É–π –ø–æ —à–∞–≥—É A
   - üìã –£–ó–ù–ê–¢–¨ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é/—Ü–µ–Ω—É ‚Üí –¥–µ–π—Å—Ç–≤—É–π –ø–æ —à–∞–≥—É B
   - üîß –£–¢–û–ß–ù–ò–¢–¨ –¥–µ—Ç–∞–ª–∏ ‚Üí –¥–µ–π—Å—Ç–≤—É–π –ø–æ —à–∞–≥—É C

–®–ê–ì A: –ï–°–õ–ò –ö–õ–ò–ï–ù–¢ –•–û–ß–ï–¢ –ó–ê–ü–ò–°–ê–¢–¨–°–Ø
{"1. –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (–µ—Å—Ç—å —Å–ª–æ–≤–∞ '–∑–∞–ø–∏—Å–∞—Ç—å—Å—è', '–∑–∞–≤—Ç—Ä–∞' –∏ —Ç.–¥.)" if basic_registration_check else ""}
{"2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É—Ç–æ—á–Ω–∏–ª: '{last_procedure}'" if last_procedure and not any(word in message_lower for word in ["—ç–ø–∏–ª—è—Ü–∏—è", "—á–∏—Å—Ç–∫–∞", "–±–æ—Ç–æ–∫—Å"]) else ""}
3. –î–ï–ô–°–¢–í–ò–Ø:
   ‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É/–∑–æ–Ω—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã
   ‚Ä¢ –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –Ω–µ —è—Å–Ω–∞ - –£–¢–û–ß–ù–ò ("–ù–∞ –∫–∞–∫—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?")
   ‚Ä¢ –ü–û–ü–†–û–°–ò –∫–æ–Ω—Ç–∞–∫—Ç—ã: "–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏"
   ‚Ä¢ –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞–ø–∏—Å—å

–®–ê–ì B: –ï–°–õ–ò –ö–õ–ò–ï–ù–¢ –°–ü–†–ê–®–ò–í–ê–ï–¢ –ò–ù–§–û–†–ú–ê–¶–ò–Æ
1. –î–∞–π –ü–û–õ–ù–´–ô –æ—Ç–≤–µ—Ç –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–π—Å –Ω–∏–∂–µ
2. –£–ø–æ–º—è–Ω–∏ –∞–ø–ø–∞—Ä–∞—Ç—ã –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
3. –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ

–®–ê–ì C: –ï–°–õ–ò –ö–õ–ò–ï–ù–¢ –£–¢–û–ß–ù–Ø–ï–¢ –î–ï–¢–ê–õ–ò
{"1. –ö–ª–∏–µ–Ω—Ç —É—Ç–æ—á–Ω—è–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: '{last_procedure}'" if last_procedure else ""}
1. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–π—Å
2. –ü–æ–º–æ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–∑–∞–ø–∏—Å—å –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

================================================================================
–ö–õ–ò–ï–ù–¢ –ü–ò–®–ï–¢: "{message}"

–¢–í–û–ô –û–¢–í–ï–¢ (–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –∏–∑ GLADIS):
{"1. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞.'" if is_first_in_session else "1. –ù–ï –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Å–Ω–æ–≤–∞"}
2. –û—Ç–≤–µ—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ –∞–Ω–∞–ª–∏–∑—É –≤—ã—à–µ
3. –ë—É–¥—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π
4. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
5. {"–£–ø–æ–º—è–Ω–∏ —Å–∫–∏–¥–∫–∏/–∞–∫—Ü–∏–∏ –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ü–µ–Ω—ã" if "—Ü–µ–Ω–∞" in message_lower or "—Å—Ç–æ–∏–º–æ—Å—Ç—å" in message_lower else ""}

–û–¢–í–ï–¢:"""
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º AI
        client = replicate.Client(api_token=api_key)
        
        output = replicate.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": full_prompt,
                "max_tokens": 1000,
                "temperature": 0.7,
                "top_p": 0.9
            }
        )
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        result = result.strip()
        print(f"   –û—Ç–≤–µ—Ç AI (—Å—ã—Ä–æ–π): '{result[:200]}...'")
        
        # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if not result or len(result) < 10:
            result = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 8-928-458-32-88 –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
        
        # –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not is_first_in_session:
            result = re.sub(r'^–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!\.]?\s*', '', result)
            result = re.sub(r'^–î–æ–±—Ä—ã–π –¥–µ–Ω—å[!\.]?\s*', '', result)
            result = re.sub(r'^–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!\.]?\s*', '', result)
            result = re.sub(r'^–ü—Ä–∏–≤–µ—Ç[!\.]?\s*', '', result)
            result = re.sub(r'^–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞[!\.]?\s*', '', result)
        
        # –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è: –µ—Å–ª–∏ AI –∑–∞–±—ã–ª –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏ —è–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏
        if basic_registration_check and "–∑–∞–ø–∏—Å" in message_lower:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø—Ä–æ—Å–∏–ª –ª–∏ AI –∫–æ–Ω—Ç–∞–∫—Ç—ã
            has_contacts_request = any(phrase in result.lower() for phrase in [
                "–∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω", "–≤–∞—à–µ –∏–º—è", "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "–∫–æ–Ω—Ç–∞–∫—Ç", "—Ç–µ–ª–µ—Ñ–æ–Ω"
            ])
            
            if not has_contacts_request and "—Å–ø–∞—Å–∏–±–æ" not in result.lower():
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                result += "\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ —É–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏."
        
        return result
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI: {str(e)}")
        import traceback
        print(f"‚ùå Traceback: {traceback.format_exc()}")
        
        # Fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ AI
        message_lower = message.lower()
        
        if telegram_sent:
            return "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
        elif has_name and has_phone:
            return "–°–ø–∞—Å–∏–±–æ! –ß–µ–º –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å?"
        elif "–∑–∞–ø–∏—Å" in message_lower:
            if last_procedure:
                return f"–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ {last_procedure} —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω. –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
            else:
                return "–î–ª—è –∑–∞–ø–∏—Å–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω. –¢–∞–∫–∂–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞ –∫–∞–∫—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è. –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
        elif "–∞–¥—Ä–µ—Å" in message_lower or "—Ç–µ–ª–µ—Ñ–æ–Ω" in message_lower:
            return "–ö–ª–∏–Ω–∏–∫–∞ GLADIS:\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-928-458-32-88\nüìç –ê–¥—Ä–µ—Å–∞: –°–æ—á–∏, —É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22 –∏ –ê–¥–ª–µ—Ä, —É–ª. –ö–∏—Ä–æ–≤–∞, –¥. 26–∞"
        elif "–ø–∏–≥–º–µ–Ω—Ç" in message_lower or "–ø—è—Ç–Ω" in message_lower:
            return "–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∏–≥–º–µ–Ω—Ç–Ω—ã—Ö –ø—è—Ç–µ–Ω –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± ‚Äî —Ñ–æ—Ç–æ–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∞–ø–ø–∞—Ä–∞—Ç–µ Lumecca (–°–®–ê)! –¶–µ–Ω–∞ –æ—Ç 4000 —Ä—É–±. –∑–∞ –ª–∏—Ü–æ. –•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?"
        else:
            return "–î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 8-928-458-32-88"

def extract_name_with_ai(api_key: str, message: str) -> str:
    """
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.
    """
    try:
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞. –ï—Å–ª–∏ –µ—Å—Ç—å - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∏–º—è. –ï—Å–ª–∏ –Ω–µ—Ç - –≤–µ—Ä–Ω–∏ "not_found".

–í–û–¢ –ü–†–ê–í–ò–õ–ê:
1. –ò–º—è - —ç—Ç–æ –ª–∏—á–Ω–æ–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ (–ê–Ω–Ω–∞, –ò–≤–∞–Ω, –ú–∞—Ä–∏—è, –î–º–∏—Ç—Ä–∏–π –∏ —Ç.–¥.)
2. –ù–ï –∏–º—è: –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä (–±–æ—Ç–æ–∫—Å, —ç–ø–∏–ª—è—Ü–∏—è, —á–∏—Å—Ç–∫–∞, –ø–∏–ª–∏–Ω–≥ –∏ —Ç.–¥.)
3. –ù–ï –∏–º—è: –æ–±—â–∏–µ —Å–ª–æ–≤–∞ (–ø—Ä–∏–≤–µ—Ç, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —Ö–æ—á—É, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏ —Ç.–¥.)
4. –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –≤–µ—Ä–Ω–∏ "not_found"

–ü—Ä–∏–º–µ—Ä—ã:
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —Ö–æ—á—É –Ω–∞ –±–æ—Ç–æ–∫—Å" ‚Üí –û—Ç–≤–µ—Ç: "–ê–Ω–Ω–∞"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–æ—Ç–æ–∫—Å" ‚Üí –û—Ç–≤–µ—Ç: "not_found"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ò–≤–∞–Ω, 89161234567" ‚Üí –û—Ç–≤–µ—Ç: "–ò–≤–∞–Ω"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ë–æ—Ç–æ–∫—Å –Ω–∞ –≥—É–±—ã" ‚Üí –û—Ç–≤–µ—Ç: "not_found"

–°–æ–æ–±—â–µ–Ω–∏–µ: "{message}"

–û—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ –∏–º—è –∏–ª–∏ "not_found"):"""

        client = replicate.Client(api_token=api_key)
        
        output = client.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": prompt,
                "max_tokens": 20,
                "temperature": 0.1,
                "top_p": 0.9
            }
        )
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        result = result.strip().lower()
        print(f"üîç AI –∞–Ω–∞–ª–∏–∑ –∏–º–µ–Ω–∏ –∏–∑ '{message}': –ø–æ–ª—É—á–∏–ª '{result}'")
        
        # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç
        if result in ['not_found', 'none', 'null', '–Ω–µ—Ç', 'no name', '']:
            return None
        
        # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
        result = re.sub(r'["\'\.,!?]', '', result).strip()
        
        if not result:
            return None
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
        procedure_keywords = [
            '–±–æ—Ç–æ–∫—Å', '–±–æ—Ç—É–ª–∏–Ω', '–¥–∏—Å–ø–æ—Ä—Ç', '—Ä–µ–ª–∞—Ç–æ–∫—Å', '–±–æ—Ç—É–ª–∞–∫—Å',
            '—ç–ø–∏–ª—è—Ü–∏—è', '–ª–∞–∑–µ—Ä–Ω–∞—è', '–±–∏–æ—Ä–µ–≤–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '—á–∏—Å—Ç–∫–∞',
            '–ø–∏–ª–∏–Ω–≥', '–ª–∏—Ñ—Ç–∏–Ω–≥', '—Å–º–∞—Å', '–º–æ—Ä—Ñ–∏—É—Å', '–ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π',
            '–º–∞–∫–∏—è–∂', '–∫–æ–Ω—Ç—É—Ä–Ω–∞—è', '–ø–ª–∞—Å—Ç–∏–∫–∞', '–º–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è',
            '–∫–æ–ª–ª–∞–≥–µ–Ω', '—Ö–∏–º–∏—á–µ—Å–∫–∏–π', '—Ä–µ—Ç–∏–Ω–æ–ª–æ–≤—ã–π', '–∫–∞—Ä–±–æ–Ω–æ–≤—ã–π'
        ]
        
        if any(proc in result for proc in procedure_keywords):
            print(f"‚ö†Ô∏è –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: '{result}' –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É")
            return None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∏–º—è
        if not re.match(r'^[–ê-–Ø–Å–∞-—è—ë\-]+$', result):
            return None
        
        # –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É
        if '-' in result:
            parts = result.split('-')
            result = '-'.join([part.capitalize() for part in parts])
        else:
            result = result.capitalize()
        
        # –î–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–∑—É–º–Ω–æ–π
        if len(result) < 2 or len(result) > 30:
            return None
        
        return result if result else None
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: {str(e)}")
        return None

def check_interesting_application(text: str):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É.
    """
    t = text.lower()
    
    # –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–ü–ò–°–û–ö –ö–õ–Æ–ß–ï–í–´–• –°–õ–û–í
    procedure_keywords = [
        "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—Å—å", "–∑–∞–ø–∏—Å–∞—Ç—å", "—Ö–æ—á—É", "–º–æ–∂–Ω–æ", "–º–Ω–µ –Ω—É–∂–Ω–æ",
        "–Ω—É–∂–Ω–æ", "–≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ", "–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç", "–∏–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å", "–ø—Ä–æ—Ü–µ–¥—É—Ä",
        "—ç–ø–∏–ª—è—Ü–∏—è", "–ª–∞–∑–µ—Ä–Ω–∞—è", "–±–æ—Ç–æ–∫—Å", "–±–æ—Ç—É–ª–∏–Ω", "—á–∏—Å—Ç–∫–∞",
        "–ø–∏–ª–∏–Ω–≥", "–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ", "–ª–∏—Ñ—Ç–∏–Ω–≥", "smas", "–º–æ—Ä—Ñ–∏—É—Å",
        "–±–∏–æ—Ä–µ–≤–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è", "–∏–Ω—ä–µ–∫—Ü–∏—è", "—É–∫–æ–ª", "–≥–∏–∞–ª—É—Ä–æ–Ω–æ–≤–∞—è",
        "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", "–≤—Ä–∞—á", "–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "–ø—Ä–∏–µ–º",
        "–±—Ä–æ–≤–∏", "—Ä–µ—Å–Ω–∏—Ü—ã", "–ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ",
        "—Ç–∞—Ç—É", "—Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞", "—É–¥–∞–ª–µ–Ω–∏–µ", "–ø–µ—Ä–º–∞–Ω–µ–Ω—Ç",
        "–º–∞—Å—Å–∞–∂", "–º–∏–∫—Ä–æ—Ç–æ–∫–∏", "–º–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è", "—Ä–æ–ª–∏–∫–æ–≤—ã–π",
        "–∫–æ–ª–ª–∞–≥–µ–Ω", "—Ö–∏–º–∏—á–µ—Å–∫–∏–π", "—Ä–µ—Ç–∏–Ω–æ–ª–æ–≤—ã–π", "–∫–∞—Ä–±–æ–Ω–æ–≤—ã–π",
        "—Å—Ç–æ–∏—Ç", "—Ü–µ–Ω–∞", "–ø—Ä–∞–π—Å", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ",
        "–±–∏–∫–∏–Ω–∏", "–ø–æ–¥–º—ã—à–∫–∏", "–≥–æ–ª–µ–Ω–∏", "–±–µ–¥—Ä–∞", "–ª–∏—Ü–æ",
        "—à–µ—è", "—Å–ø–∏–Ω–∞", "–∂–∏–≤–æ—Ç", "—Ä—É–∫–∏", "–Ω–æ–≥–∏",
        "–∫–∞–ø–µ–ª—å–Ω–∏—Ü", "–¥–µ—Ç–æ–∫—Å", "–≤–∏—Ç–∞–º–∏–Ω", "–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ",
        "–ø–∏–≥–º–µ–Ω—Ç", "–ø—è—Ç–Ω", "–≤–µ—Å–Ω—É—à–∫", "–∞–ø–ø–∞—Ä–∞—Ç", "–ª–∞–∑–µ—Ä"
    ]
    
    contact_keywords = ["–∏–º—è", "–∑–æ–≤—É—Ç", "—Ç–µ–ª–µ—Ñ–æ–Ω", "—Ç–µ–ª–µ—Ñ–æ–Ω–µ", "–Ω–æ–º–µ—Ä", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–º–Ω–µ –∑–æ–≤—É—Ç"]
    
    has_procedure = any(keyword in t for keyword in procedure_keywords)
    has_contacts = any(keyword in t for keyword in contact_keywords)
    
    print(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–∫–∏: '{text[:100]}...'")
    print(f"   –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ —Å–ª–æ–≤–∞: {has_procedure}")
    print(f"   –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Å–ª–æ–≤–∞: {has_contacts}")
    
    return has_procedure or has_contacts
