import replicate
import re
import json
import os

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–π—Å –∏–∑ —Ñ–∞–π–ª–∞
def load_procedures_prices():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å –∏–∑ —Ñ–∞–π–ª–∞."""
    try:
        file_path = os.path.join(os.path.dirname(__file__), 'data', 'procedures.json')
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: {e}")
        return {}

# –°–æ–∑–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SYSTEM_PROMPT —Å –ø–æ–ª–Ω—ã–º –ø—Ä–∞–π—Å–æ–º
def create_system_prompt():
    """–°–æ–∑–¥–∞–µ—Ç SYSTEM_PROMPT —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–∞–π—Å–æ–º."""
    procedures_data = load_procedures_prices()
    
    base_prompt = """
–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–Ω–∏–∫–∏ —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã GLADIS –≤ –°–æ—á–∏.

–¢–í–û–ô –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –∫–ª–∏–Ω–∏–∫–∏
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ü–û–õ–ù–û –∏ –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–û
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ —ç—Ç–æ, –∑–∞—á–µ–º –¥–µ–ª–∞—é—Ç, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç
- –ï—Å–ª–∏ —Ö–æ—Ç—è—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî –ø–æ–ø—Ä–æ—Å–∏ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
- –ë—É–¥—å –ø–æ–ª–µ–∑–Ω–æ–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ü–†–ï–î–°–¢–ê–í–õ–Ø–ô–°–Ø –¢–û–õ–¨–ö–û –ü–†–ò –ü–ï–†–í–û–ú –û–¢–í–ï–¢–ï –ò–õ–ò –ï–°–õ–ò –ö–õ–ò–ï–ù–¢ –°–ü–†–ê–®–ò–í–ê–ï–¢ "–ö–¢–û –¢–´?"
2. –ù–ï –ü–û–í–¢–û–†–Ø–ô "–ó–î–†–ê–í–°–¢–í–£–ô–¢–ï" –í –ö–ê–ñ–î–û–ú –°–û–û–ë–©–ï–ù–ò–ò
3. –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –ø—Ä–æ—Å—Ç—ã–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º
4. –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–æ–±–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
   - –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è", "–¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º—Å—è"
   - –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?"
   - –ó–∞–≤–µ—Ä—à–∞–µ—à—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∏ –∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏

–ö–û–ù–¢–ê–ö–¢–´ –ö–õ–ò–ù–ò–ö–ò (–¥–æ–±–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ):
üìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-928-458-32-88
üìç –ê–¥—Ä–µ—Å–∞:
   ‚Ä¢ –°–æ—á–∏: —É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22
   ‚Ä¢ –ê–¥–ª–µ—Ä: —É–ª. –ö–∏—Ä–æ–≤–∞, –¥. 26–∞
‚è∞ –†–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 10:00 –¥–æ 20:00

–í–ê–ñ–ù–û: –†–∞—Å—Å—Ä–æ—á–∫—É –∏ –∫—Ä–µ–¥–∏—Ç –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º!
"""

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å
    price_section = "\n–ü–û–õ–ù–´–ô –ü–†–ê–ô–° –ü–†–û–¶–ï–î–£–† –ö–õ–ò–ù–ò–ö–ò GLADIS:\n\n"
    
    if procedures_data and 'procedures' in procedures_data:
        for procedure in procedures_data['procedures']:
            name = procedure.get('name', '')
            category = procedure.get('category', '')
            
            price_section += f"{name} ({category}):\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if 'prices' in procedure and procedure['prices']:
                for zone, price in procedure['prices'].items():
                    price_section += f"  ‚Ä¢ {zone}: {price} —Ä—É–±.\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–ª–µ–∫—Å—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if 'complexes' in procedure and procedure['complexes']:
                price_section += f"  –ö–æ–º–ø–ª–µ–∫—Å—ã:\n"
                for complex_name, complex_price in procedure['complexes'].items():
                    price_section += f"    ‚Ä¢ {complex_name}: {complex_price} —Ä—É–±.\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
            if 'note' in procedure:
                price_section += f"  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: {procedure['note']}\n"
            
            price_section += "\n"
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–π—Å, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
    else:
        price_section += """
–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ —Ü–µ–Ω—ã:

1. –õ–ê–ó–ï–†–ù–ê–Ø –≠–ü–ò–õ–Ø–¶–ò–Ø:
   ‚Ä¢ –ü–æ–¥–º—ã—à–∫–∏: 1100-1400 —Ä—É–±
   ‚Ä¢ –ë–∏–∫–∏–Ω–∏: 1900-3500 —Ä—É–±
   ‚Ä¢ –ì–æ–ª–µ–Ω–∏: 2550-3300 —Ä—É–±
   ‚Ä¢ –ù–æ–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é: 4500-5800 —Ä—É–±

2. –ë–ò–û–†–ï–í–ò–¢–ê–õ–ò–ó–ê–¶–ò–Ø:
   ‚Ä¢ –ö–æ–∫—Ç–µ–π–ª—å Monaco: 18000-25000 —Ä—É–±
   ‚Ä¢ Hyaron: 5500 —Ä—É–±
   ‚Ä¢ Profhilo: 18000 —Ä—É–±
   ‚Ä¢ –¢—Ä–∏—Ö–æ–ª–∞–∫—Å (–¥–ª—è –≤–æ–ª–æ—Å): 6000 —Ä—É–±

3. –ß–ò–°–¢–ö–ê –õ–ò–¶–ê:
   ‚Ä¢ –£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è/–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è: 3900 —Ä—É–±
   ‚Ä¢ –ö–∞—Ä–±–æ–Ω–æ–≤—ã–π –ø–∏–ª–∏–Ω–≥: 3350 —Ä—É–±
   ‚Ä¢ Hydrafacial: 4500 —Ä—É–±

4. –ë–û–¢–£–õ–û–¢–û–ö–°–ò–ù:
   ‚Ä¢ –†–µ–ª–∞—Ç–æ–∫—Å/–ë–æ—Ç—É–ª–∞–∫—Å: 250 —Ä—É–±/–µ–¥.
   ‚Ä¢ –ì–∏–ø–µ—Ä–≥–∏–¥—Ä–æ–∑: 20000 —Ä—É–±

5. –ü–ò–õ–ò–ù–ì–ò: –æ—Ç 2000 –¥–æ 6000 —Ä—É–±
6. –õ–ò–§–¢–ò–ù–ì: –æ—Ç 16500 –¥–æ 60000 —Ä—É–±
7. –ü–ï–†–ú–ê–ù–ï–ù–¢–ù–´–ô –ú–ê–ö–ò–Ø–ñ: –æ—Ç 5500 –¥–æ 8000 —Ä—É–±
"""
    
    full_prompt = base_prompt + price_section
    
    return full_prompt

def is_simple_greeting(message: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º."""
    message_lower = message.lower()
    
    greetings = [
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞—Å—å—Ç–µ", "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é",
        "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫", "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏", "–¥–æ–±—Ä—ã–π",
        "–∑–¥—Ä–∞–≤–∏—è", "–ø—Ä–∏–≤–µ—Ç–∏–∫", "–¥–æ–±—Ä–æ–≥–æ"
    ]
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    for greeting in greetings:
        if greeting in message_lower:
            clean_msg = message_lower.replace(greeting, "").strip()
            if not clean_msg or len(clean_msg.replace(" ", "")) < 3:
                return True
    
    return False

def is_registration_request(message: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è."""
    message_lower = message.lower()
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–ø–µ—á–∞—Ç–∫–∏
    corrected_message = message_lower
    corrections = {
        "—Ö–æ—á—Ü—É": "—Ö–æ—á—É",
        "–∑–∞–ø–∏—Å–∞—Ü—Ü–∞": "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", 
        "–∑–∞–ø–∏—Å–∞—Ç—Å—è": "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–∑–∞–ø–∏—Å–∞—Ü–∞": "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–∑–∞–ø–∏—Å–∞—Ü–æ": "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
    }
    
    for wrong, correct in corrections.items():
        corrected_message = corrected_message.replace(wrong, correct)
    
    registration_phrases = [
        "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º", "—Ö–æ—á—É –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É",
        "—Ö–æ—Ç–µ–ª –±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞", "–∑–∞–ø–∏—Å—å –Ω–∞",
        "–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞", "—Ö–æ—á—É —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø–∏—Å—å",
        "—Ö–æ—á—É –ø–æ–ø–∞—Å—Ç—å –Ω–∞", "–º–Ω–µ –Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å",
        "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞", "–∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞"
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if any(phrase in corrected_message for phrase in registration_phrases):
        return True
    
    # –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ "–∑–∞–ø–∏—Å" –∏ –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è
    if "–∑–∞–ø–∏—Å" in corrected_message:
        action_words = ["—Ö–æ—á—É", "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "–≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ", "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞", "–º–Ω–µ"]
        if any(word in corrected_message for word in action_words):
            return True
    
    return False

def should_add_contacts_to_reply(user_message: str, bot_reply: str, is_first_message: bool = False) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –æ—Ç–≤–µ—Ç—É.
    """
    user_lower = user_message.lower()
    reply_lower = bot_reply.lower()
    
    # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –µ—Å–ª–∏:
    # 1. –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
    if is_registration_request(user_message):
        return True
    
    # 2. –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    if any(word in user_lower for word in ["—Ç–µ–ª–µ—Ñ–æ–Ω", "–∞–¥—Ä–µ—Å", "–∫–æ–Ω—Ç–∞–∫—Ç", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–Ω–æ–º–µ—Ä", "–∫–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è"]):
        return True
    
    # 3. –í –æ—Ç–≤–µ—Ç–µ —É–∂–µ –ø—Ä–æ—Å—è—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã (—è–≤–Ω–æ)
    if any(phrase in reply_lower for phrase in [
        "–¥–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω",
        "—É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏",
        "–Ω–∞–∑–æ–≤–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏",
        "–º–Ω–µ –Ω—É–∂–Ω—ã –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏"
    ]):
        return True
    
    # 4. –≠—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (–¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç) –ò –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–ª –∏–Ω—Ç–µ—Ä–µ—Å
    if len(bot_reply) > 300 and ("—Ä—É–±" in reply_lower or "—Å—Ç–æ–∏–º–æ—Å—Ç—å" in reply_lower):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏
        if "–∑–∞–ø–∏—Å" in user_lower:
            return True
    
    # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –µ—Å–ª–∏:
    # 1. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if is_simple_greeting(user_message):
        return False
    
    # 2. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    if (len(bot_reply) < 200 and 
        "?" in user_message and 
        not is_registration_request(user_message)):
        return False
    
    return False

def generate_bot_reply(api_key: str, message: str, is_first_in_session: bool = False, 
                      has_name: bool = False, has_phone: bool = False,
                      telegram_sent: bool = False) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Replicate API."""
    try:
        print(f"\nü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI")
        print(f"   –°–æ–æ–±—â–µ–Ω–∏–µ: '{message}'")
        print(f"   –ü–µ—Ä–≤–æ–µ –≤ —Å–µ—Å—Å–∏–∏: {is_first_in_session}")
        print(f"   –ï—Å—Ç—å –∏–º—è: {has_name}, –ï—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω: {has_phone}")
        print(f"   Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {telegram_sent}")
        
        message_lower = message.lower()
        
        # 1. –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
        if is_simple_greeting(message_lower):
            if is_first_in_session:
                return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞. –ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
            else:
                return "–ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
        
        # 2. –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Telegram - –ö–û–ù–ï–¶ –î–ò–ê–õ–û–ì–ê
        if telegram_sent:
            return "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
        wants_registration = is_registration_request(message)
        
        # 4. –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - –ó–ê–í–ï–†–®–ê–ï–ú –î–ò–ê–õ–û–ì
        if has_name and has_phone and wants_registration:
            # –ö–ª–∏–µ–Ω—Ç –¥–∞–ª –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - –∑–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
            system_prompt = """
–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–Ω–∏–∫–∏ —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã GLADIS –≤ –°–æ—á–∏.
–ö–ª–∏–µ–Ω—Ç —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω, —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ó–ê–Ø–í–ö–£ –ò –ó–ê–í–ï–†–®–ò–¢–¨ –î–ò–ê–õ–û–ì.

–í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ù–ï –∑–∞–¥–∞–≤–∞–π –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤
2. –ù–ï –ø—Ä–æ—Å–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
3. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
4. –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞—è–≤–∫—É –∏ –ø–æ–ø—Ä–æ—â–∞–π—Å—è
5. –£–ø–æ–º—è–Ω–∏ —á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–ë—É–¥—å –≤–µ–∂–ª–∏–≤–æ–π, –Ω–æ –ö–û–†–û–¢–ö–û–ô.
"""
            full_prompt = f"""{system_prompt}

–ö–ª–∏–µ–Ω—Ç —É–∂–µ –¥–∞–ª –∫–æ–Ω—Ç–∞–∫—Ç—ã (–∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω).
–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É.

–ö–õ–ò–ï–ù–¢ –ø–∏—à–µ—Ç: "{message}"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç (–ö–û–†–û–¢–ö–û, –ó–ê–í–ï–†–®–ê–Æ–©–ò–ô –¥–∏–∞–ª–æ–≥):
1. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
2. –°–∫–∞–∂–∏ —á—Ç–æ –∑–∞—è–≤–∫–∞ –ë–£–î–ï–¢ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É
3. –£–ø–æ–º—è–Ω–∏ —á—Ç–æ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –ü–û–ü–†–û–©–ê–ô–°–Ø –∏ –∑–∞–≤–µ—Ä—à–∏ –¥–∏–∞–ª–æ–≥
5. –ú–ê–ö–°–ò–ú–£–ú 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
6. –ù–ï –∑–∞–¥–∞–≤–∞–π –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤

–û–¢–í–ï–¢:"""
        
        # 5. –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã, –Ω–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç –æ –∑–∞–ø–∏—Å–∏
        elif has_name and has_phone and not wants_registration:
            system_prompt = """
–¢—ã ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–Ω–∏–∫–∏ —ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã GLADIS –≤ –°–æ—á–∏.
–£ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –ù–ï –ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–Ω–æ–≤–∞.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞—Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - —Å—Ä–∞–∑—É –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞—è–≤–∫—É.
–ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π.
"""
            full_prompt = f"""{system_prompt}

–ö–û–ù–¢–ï–ö–°–¢:
- –£ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ
- –ö–ª–∏–µ–Ω—Ç –ù–ï –≥–æ–≤–æ—Ä–∏—Ç –æ –∑–∞–ø–∏—Å–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

–ö–õ–ò–ï–ù–¢ –ø–∏—à–µ—Ç: "{message}"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç:
1. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
2. –ù–ï –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Å–Ω–æ–≤–∞
3. –ù–ï –ø—Ä–æ—Å–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å)
4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞—Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞—è–≤–∫—É
5. –ë—É–¥—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π

–û–¢–í–ï–¢:"""
        
        # 6. –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –Ω–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - –ü–†–û–°–ò–ú –ö–û–ù–¢–ê–ö–¢–´
        elif wants_registration and (not has_name or not has_phone):
            system_prompt = create_system_prompt()
            
            missing_what = []
            if not has_name:
                missing_what.append("–∏–º—è")
            if not has_phone:
                missing_what.append("—Ç–µ–ª–µ—Ñ–æ–Ω")
            missing_text = " –∏ ".join(missing_what)
            
            full_prompt = f"""{system_prompt}

–ö–û–ù–¢–ï–ö–°–¢:
- –ö–ª–∏–µ–Ω—Ç –•–û–ß–ï–¢ –ó–ê–ü–ò–°–ê–¢–¨–°–Ø
- –ù–µ—Ç {missing_text}

–ö–õ–ò–ï–ù–¢ –ø–∏—à–µ—Ç: "{message}"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç:
1. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ (–µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
2. –ü–û–ü–†–û–°–ò –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ: {missing_text}
3. –û–±—ä—è—Å–Ω–∏ —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–ø–∏—Å–∏
4. –ë—É–¥—å –≤–µ–∂–ª–∏–≤–æ–π, –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ–π –≤ —Å–±–æ—Ä–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

–û–¢–í–ï–¢:"""
        
        # 7. –û–±—ã—á–Ω—ã–π –¥–∏–∞–ª–æ–≥ (–Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –Ω–µ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è)
        else:
            system_prompt = create_system_prompt()
            
            full_prompt = f"""{system_prompt}

–ö–û–ù–¢–ï–ö–°–¢:
- {'–≠—Ç–æ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞, –Ω—É–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è' if is_first_in_session else '–î–∏–∞–ª–æ–≥ —É–∂–µ –∏–¥–µ—Ç, –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Å–Ω–æ–≤–∞'}
- –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è: {wants_registration}
- {'–£ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω' if has_name and has_phone else '–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –µ—â–µ –Ω–µ—Ç'}

–ö–õ–ò–ï–ù–¢ –ø–∏—à–µ—Ç: "{message}"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç (–∫–∞–∫ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞):
1. {'–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–ª–∏–Ω–∏–∫–∞ GLADIS, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞."' if is_first_in_session else '–ù–ï –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è —Å–Ω–æ–≤–∞'}
2. –û—Ç–≤–µ—Ç—å –ü–û–õ–ù–û –Ω–∞ –≤–æ–ø—Ä–æ—Å
3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –•–û–ß–ï–¢ –ó–ê–ü–ò–°–ê–¢–¨–°–Ø –∏ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ‚Äî –ø–æ–ø—Ä–æ—Å–∏ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
4. –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –ò —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞—è–≤–∫—É –∏ –∑–∞–≤–µ—Ä—à–∏ –¥–∏–∞–ª–æ–≥
5. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å
6. –ë—É–¥—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π

–û–¢–í–ï–¢:"""
        
        # 8. –ò—Å–ø–æ–ª—å–∑—É–µ–º AI
        client = replicate.Client(api_token=api_key)
        
        output = replicate.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": full_prompt,
                "max_tokens": 800,
                "temperature": 0.7,
                "top_p": 0.9
            }
        )
        
        # 9. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        result = result.strip()
        print(f"   –û—Ç–≤–µ—Ç AI (—Å—ã—Ä–æ–π): '{result[:200]}...'")
        
        # 10. –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if not result or len(result) < 10:
            result = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 8-928-458-32-88 –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
        
        # 11. –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not is_first_in_session:
            result = re.sub(r'^–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!\.]?\s*', '', result)
            result = re.sub(r'^–î–æ–±—Ä—ã–π –¥–µ–Ω—å[!\.]?\s*', '', result)
            result = re.sub(r'^–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!\.]?\s*', '', result)
            result = re.sub(r'^–ü—Ä–∏–≤–µ—Ç[!\.]?\s*', '', result)
            result = re.sub(r'^–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞[!\.]?\s*', '', result)
        
        # 12. –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â—É—é —Ñ—Ä–∞–∑—É
        if has_name and has_phone and wants_registration and not telegram_sent:
            if "—Å–ø–∞—Å–∏–±–æ" not in result.lower() and "–ø–µ—Ä–µ–¥–∞" not in result.lower():
                result = "‚úÖ –°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏."
        
        return result
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI: {str(e)}")
        import traceback
        print(f"‚ùå Traceback: {traceback.format_exc()}")
        
        # Fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ AI
        message_lower = message.lower()
        
        if telegram_sent:
            return "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏."
        elif has_name and has_phone and wants_registration:
            return "‚úÖ –°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏."
        elif has_name and has_phone:
            return "–°–ø–∞—Å–∏–±–æ! –ß–µ–º –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å?"
        elif "–∑–∞–ø–∏—Å" in message_lower:
            return "–î–ª—è –∑–∞–ø–∏—Å–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω. –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–Ω–∏–∫–∏: 8-928-458-32-88"
        elif "–∞–¥—Ä–µ—Å" in message_lower or "—Ç–µ–ª–µ—Ñ–æ–Ω" in message_lower:
            return "–ö–ª–∏–Ω–∏–∫–∞ GLADIS:\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-928-458-32-88\nüìç –ê–¥—Ä–µ—Å–∞: –°–æ—á–∏, —É–ª. –í–æ—Ä–æ–≤—Å–∫–æ–≥–æ, 22 –∏ –ê–¥–ª–µ—Ä, —É–ª. –ö–∏—Ä–æ–≤–∞, –¥. 26–∞"
        else:
            return "–î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 8-928-458-32-88"

def extract_name_with_ai(api_key: str, message: str) -> str:
    """
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –∏–º–µ–Ω–∞, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä.
    """
    try:
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞. –ï—Å–ª–∏ –µ—Å—Ç—å - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∏–º—è. –ï—Å–ª–∏ –Ω–µ—Ç - –≤–µ—Ä–Ω–∏ "not_found".

–í–û–¢ –ü–†–ê–í–ò–õ–ê:
1. –ò–º—è - —ç—Ç–æ –ª–∏—á–Ω–æ–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ (–ê–Ω–Ω–∞, –ò–≤–∞–Ω, –ú–∞—Ä–∏—è, –î–º–∏—Ç—Ä–∏–π –∏ —Ç.–¥.)
2. –ù–ï –∏–º—è: –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä (–±–æ—Ç–æ–∫—Å, —ç–ø–∏–ª—è—Ü–∏—è, —á–∏—Å—Ç–∫–∞, –ø–∏–ª–∏–Ω–≥ –∏ —Ç.–¥.)
3. –ù–ï –∏–º—è: –æ–±—â–∏–µ —Å–ª–æ–≤–∞ (–ø—Ä–∏–≤–µ—Ç, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —Ö–æ—á—É, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏ —Ç.–¥.)
4. –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –≤–µ—Ä–Ω–∏ "not_found"

–ü—Ä–∏–º–µ—Ä—ã:
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —Ö–æ—á—É –Ω–∞ –±–æ—Ç–æ–∫—Å" ‚Üí –û—Ç–≤–µ—Ç: "–ê–Ω–Ω–∞"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–æ—Ç–æ–∫—Å" ‚Üí –û—Ç–≤–µ—Ç: "not_found"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ò–≤–∞–Ω, 89161234567" ‚Üí –û—Ç–≤–µ—Ç: "–ò–≤–∞–Ω"
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ë–æ—Ç–æ–∫—Å –Ω–∞ –≥—É–±—ã" ‚Üí –û—Ç–≤–µ—Ç: "not_found"

–°–æ–æ–±—â–µ–Ω–∏–µ: "{message}"

–û—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ –∏–º—è –∏–ª–∏ "not_found"):"""

        client = replicate.Client(api_token=api_key)
        
        output = client.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": prompt,
                "max_tokens": 20,
                "temperature": 0.1,
                "top_p": 0.9
            }
        )
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        result = result.strip().lower()
        print(f"üîç AI –∞–Ω–∞–ª–∏–∑ –∏–º–µ–Ω–∏ –∏–∑ '{message}': –ø–æ–ª—É—á–∏–ª '{result}'")
        
        # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç
        if result in ['not_found', 'none', 'null', '–Ω–µ—Ç', 'no name', '']:
            return None
        
        # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
        result = re.sub(r'["\'\.,!?]', '', result).strip()
        
        if not result:
            return None
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        procedure_keywords = [
            '–±–æ—Ç–æ–∫—Å', '–±–æ—Ç—É–ª–∏–Ω', '–¥–∏—Å–ø–æ—Ä—Ç', '—Ä–µ–ª–∞—Ç–æ–∫—Å', '–±–æ—Ç—É–ª–∞–∫—Å',
            '—ç–ø–∏–ª—è—Ü–∏—è', '–ª–∞–∑–µ—Ä–Ω–∞—è', '–±–∏–æ—Ä–µ–≤–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '—á–∏—Å—Ç–∫–∞',
            '–ø–∏–ª–∏–Ω–≥', '–ª–∏—Ñ—Ç–∏–Ω–≥', '—Å–º–∞—Å', '–º–æ—Ä—Ñ–∏—É—Å', '–ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π',
            '–º–∞–∫–∏—è–∂', '–∫–æ–Ω—Ç—É—Ä–Ω–∞—è', '–ø–ª–∞—Å—Ç–∏–∫–∞', '–º–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è'
        ]
        
        if any(proc in result for proc in procedure_keywords):
            print(f"‚ö†Ô∏è –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: '{result}' –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É")
            return None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∏–º—è (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –¥–µ—Ñ–∏—Å—ã)
        if not re.match(r'^[–ê-–Ø–Å–∞-—è—ë\-]+$', result):
            return None
        
        # –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É
        if '-' in result:
            parts = result.split('-')
            result = '-'.join([part.capitalize() for part in parts])
        else:
            result = result.capitalize()
        
        # –î–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–∑—É–º–Ω–æ–π
        if len(result) < 2 or len(result) > 30:
            return None
        
        return result if result else None
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ AI –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: {str(e)}")
        return None

def check_interesting_application(text: str):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É.
    """
    t = text.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
    procedure_keywords = [
        "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—Å—å", "–∑–∞–ø–∏—Å–∞—Ç—å", "—Ö–æ—á—É –Ω–∞", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–∑–∞–ø–∏—à–∏—Ç–µ", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è", "–∑–∞–ø–∏—à–∏—Ç–µ –Ω–∞", "–∑–∞–ø–∏—Å—å –Ω–∞",
        "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–ø—Ä–∞–π—Å",
        "—ç–ø–∏–ª—è—Ü–∏—è", "–ª–∞–∑–µ—Ä–Ω–∞—è", "–±–æ—Ç–æ–∫—Å", "–±–æ—Ç—É–ª–∏–Ω", "—á–∏—Å—Ç–∫–∞",
        "–ø–∏–ª–∏–Ω–≥", "–æ–º–æ–ª–æ–∂–µ–Ω–∏–µ", "–ª–∏—Ñ—Ç–∏–Ω–≥", "smas", "–º–æ—Ä—Ñ–∏—É—Å",
        "–±–∏–æ—Ä–µ–≤–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è", "–∏–Ω—ä–µ–∫—Ü–∏—è", "—É–∫–æ–ª", "–≥–∏–∞–ª—É—Ä–æ–Ω–æ–≤–∞—è",
        "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", "–≤—Ä–∞—á", "–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "–ø—Ä–∏–µ–º",
        "–±—Ä–æ–≤–∏", "—Ä–µ—Å–Ω–∏—Ü—ã", "–ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ",
        "—Ç–∞—Ç—É", "—Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞", "—É–¥–∞–ª–µ–Ω–∏–µ", "–ø–µ—Ä–º–∞–Ω–µ–Ω—Ç",
        "–º–∞—Å—Å–∞–∂", "–º–∏–∫—Ä–æ—Ç–æ–∫–∏", "–º–µ–∑–æ—Ç–µ—Ä–∞–ø–∏—è", "—Ä–æ–ª–∏–∫–æ–≤—ã–π"
    ]
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–∏–º—è" –∏–ª–∏ "—Ç–µ–ª–µ—Ñ–æ–Ω" - —ç—Ç–æ —Ç–æ—á–Ω–æ –∑–∞—è–≤–∫–∞
    contact_keywords = ["–∏–º—è", "–∑–æ–≤—É—Ç", "—Ç–µ–ª–µ—Ñ–æ–Ω", "—Ç–µ–ª–µ—Ñ–æ–Ω–µ", "–Ω–æ–º–µ—Ä", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–º–Ω–µ –∑–æ–≤—É—Ç"]
    
    has_procedure = any(keyword in t for keyword in procedure_keywords)
    has_contacts = any(keyword in t for keyword in contact_keywords)
    
    print(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–∫–∏: '{text[:50]}...'")
    print(f"   –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ —Å–ª–æ–≤–∞: {has_procedure}")
    print(f"   –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Å–ª–æ–≤–∞: {has_contacts}")
    
    # –ó–∞—è–≤–∫–æ–π —Å—á–∏—Ç–∞–µ–º –µ—Å–ª–∏:
    # 1. –ï—Å—Ç—å —Å–ª–æ–≤–∞ –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö/—Ü–µ–Ω–∞—Ö –ò–õ–ò
    # 2. –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    return has_procedure or has_contacts
